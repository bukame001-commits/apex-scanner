<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>APEX SCANNER AI</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;500&display=swap');
  :root {
    --bg:#040a0f;--surface:#080f17;--card:#0a1520;--border:#0e2033;
    --accent:#00d4ff;--accent2:#00ff88;--warn:#ffb800;--danger:#ff3366;
    --text:#c8dde8;--muted:#4a6070;--strong:#ffffff;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:'Inter',sans-serif;min-height:100vh;overflow-x:hidden;}
  body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,212,255,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,255,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
  .container{position:relative;z-index:1;max-width:900px;margin:0 auto;padding:20px 16px 60px;}
  .header{text-align:center;padding:30px 0 24px;}
  .header-badge{display:inline-block;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--accent);letter-spacing:4px;border:1px solid rgba(0,212,255,0.3);padding:4px 12px;margin-bottom:12px;animation:pulse-border 2s infinite;}
  @keyframes pulse-border{0%,100%{border-color:rgba(0,212,255,0.3);}50%{border-color:rgba(0,212,255,0.8);}}
  .header h1{font-family:'Orbitron',monospace;font-size:clamp(26px,7vw,46px);font-weight:900;color:var(--strong);letter-spacing:4px;text-shadow:0 0 40px rgba(0,212,255,0.4);}
  .header h1 span{color:var(--accent);}
  .header-sub{font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--muted);letter-spacing:2px;margin-top:8px;}
  .section-label{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--accent);letter-spacing:3px;margin-bottom:10px;display:flex;align-items:center;gap:8px;}
  .section-label::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--border),transparent);}
  .card{background:var(--card);border:1px solid var(--border);border-radius:2px;padding:16px;margin-bottom:14px;position:relative;overflow:hidden;}
  .card::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:var(--accent);}

  /* AI Engine Selector */
  .engine-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  .engine-btn{background:var(--surface);border:2px solid var(--border);border-radius:2px;padding:14px;cursor:pointer;transition:all 0.15s;text-align:left;}
  .engine-btn:hover{border-color:var(--accent);}
  .engine-btn.active-claude{background:rgba(255,107,53,0.08);border-color:#ff6b35;}
  .engine-btn.active-gemini{background:rgba(0,212,255,0.08);border-color:var(--accent);}
  .engine-logo{font-size:24px;margin-bottom:6px;}
  .engine-name{font-family:'Orbitron',monospace;font-size:13px;font-weight:700;color:var(--strong);}
  .engine-name.claude{color:#ff6b35;}
  .engine-name.gemini{color:var(--accent);}
  .engine-desc{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--muted);margin-top:4px;line-height:1.5;}
  .engine-badge{display:inline-block;font-family:'Share Tech Mono',monospace;font-size:8px;padding:2px 6px;border-radius:2px;margin-top:6px;}
  .engine-badge.free{background:rgba(0,255,136,0.1);color:var(--accent2);border:1px solid rgba(0,255,136,0.3);}
  .engine-badge.paid{background:rgba(255,107,53,0.1);color:#ff6b35;border:1px solid rgba(255,107,53,0.3);}

  /* API inputs */
  .api-row{display:grid;grid-template-columns:1fr;gap:10px;}
  .api-field{display:none;}
  .api-field.visible{display:block;}
  .api-label{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--muted);margin-bottom:6px;letter-spacing:1px;}
  .api-input{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:2px;padding:10px 14px;color:var(--text);font-family:'Share Tech Mono',monospace;font-size:12px;outline:none;transition:border-color 0.15s;}
  .api-input:focus{border-color:var(--accent);}
  .api-input::placeholder{color:var(--muted);}
  .api-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;}
  .api-clear-btn{font-family:'Share Tech Mono',monospace;font-size:9px;padding:5px 10px;background:transparent;border:1px solid var(--border);color:var(--muted);cursor:pointer;letter-spacing:1px;transition:all 0.15s;}
  .api-clear-btn:hover{border-color:var(--danger);color:var(--danger);}
  .api-note{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--muted);margin-top:8px;line-height:1.6;}
  .api-note a{color:var(--accent);text-decoration:none;}

  /* Markets */
  .market-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px;}
  .market-btn{background:var(--surface);border:1px solid var(--border);border-radius:2px;padding:10px 12px;cursor:pointer;transition:all 0.15s;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--muted);text-align:left;}
  .market-btn:hover{border-color:var(--accent);color:var(--accent);}
  .market-btn.active{background:rgba(0,212,255,0.08);border-color:var(--accent);color:var(--accent);}
  .market-btn .icon{font-size:16px;display:block;margin-bottom:4px;}
  .market-btn .name{font-size:11px;font-weight:700;}
  .market-btn .desc{font-size:9px;opacity:0.6;margin-top:2px;}

  /* Indicators */
  .ind-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px;}
  .ind-btn{background:var(--surface);border:1px solid var(--border);border-radius:2px;padding:10px 12px;cursor:pointer;transition:all 0.15s;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--muted);text-align:left;position:relative;}
  .ind-btn:hover{border-color:var(--accent2);color:var(--text);}
  .ind-btn.active{background:rgba(0,255,136,0.06);border-color:var(--accent2);color:var(--accent2);}
  .ind-btn .ind-name{font-size:12px;font-weight:700;}
  .ind-btn .ind-desc{font-size:9px;opacity:0.6;margin-top:3px;}
  .ind-check{position:absolute;top:8px;right:8px;width:14px;height:14px;border:1px solid currentColor;border-radius:2px;display:flex;align-items:center;justify-content:center;font-size:9px;}

  /* Sliders */
  .slider-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
  @media(max-width:500px){.slider-grid{grid-template-columns:1fr;}}
  .slider-item label{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--muted);display:block;margin-bottom:6px;}
  .slider-item label span{color:var(--accent);float:right;font-size:12px;}
  input[type=range]{-webkit-appearance:none;width:100%;height:2px;background:var(--border);outline:none;}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:2px;background:var(--accent);cursor:pointer;box-shadow:0 0 8px rgba(0,212,255,0.6);}

  /* Scan button */
  .scan-btn{width:100%;padding:18px;background:transparent;border:1px solid var(--accent);color:var(--accent);font-family:'Orbitron',monospace;font-size:14px;font-weight:700;letter-spacing:4px;cursor:pointer;position:relative;overflow:hidden;transition:all 0.2s;margin-top:6px;}
  .scan-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(0,212,255,0.1),transparent);transform:translateX(-100%);transition:transform 0.4s;}
  .scan-btn:hover::before{transform:translateX(100%);}
  .scan-btn:hover{background:rgba(0,212,255,0.08);box-shadow:0 0 30px rgba(0,212,255,0.2);}
  .scan-btn:disabled{opacity:0.4;cursor:not-allowed;}

  /* Loading */
  .loading{display:none;text-align:center;padding:40px;font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--accent);letter-spacing:2px;}
  .loading.visible{display:block;}
  .loading-bar{width:100%;height:2px;background:var(--border);margin:16px 0;position:relative;overflow:hidden;}
  .loading-bar::after{content:'';position:absolute;top:0;left:-40%;width:40%;height:100%;background:linear-gradient(90deg,transparent,var(--accent),transparent);animation:scan-line 1.2s infinite;}
  @keyframes scan-line{0%{left:-40%;}100%{left:100%;}}

  /* Results */
  .results-section{display:none;margin-top:20px;}
  .results-section.visible{display:block;}
  .results-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:8px;}
  .results-stats{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-bottom:16px;}
  .stat-box{background:var(--card);border:1px solid var(--border);border-radius:2px;padding:10px 14px;text-align:center;}
  .stat-box .stat-val{font-family:'Orbitron',monospace;font-size:22px;font-weight:700;color:var(--accent);}
  .stat-box .stat-label{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:2px;margin-top:4px;}

  /* Alert cards */
  .alert-card{background:var(--card);border:1px solid var(--border);border-radius:2px;padding:14px 16px;margin-bottom:10px;position:relative;overflow:hidden;transition:border-color 0.15s;}
  .alert-card:hover{border-color:rgba(0,212,255,0.4);}
  .alert-card.strong::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:var(--accent2);}
  .alert-card.moderate::before{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:var(--warn);}
  .alert-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;}
  .alert-symbol{font-family:'Orbitron',monospace;font-size:16px;font-weight:700;color:var(--strong);}
  .alert-market{font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--muted);margin-top:2px;}
  .alert-score{font-family:'Orbitron',monospace;font-size:20px;font-weight:900;color:var(--accent2);}
  .alert-score.moderate{color:var(--warn);}
  .alert-signals{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;}
  .signal-tag{font-family:'Share Tech Mono',monospace;font-size:10px;padding:3px 8px;border-radius:2px;border:1px solid;}
  .signal-tag.wt{color:var(--accent);border-color:rgba(0,212,255,0.4);background:rgba(0,212,255,0.06);}
  .signal-tag.rsi{color:#ff6b35;border-color:rgba(255,107,53,0.4);background:rgba(255,107,53,0.06);}
  .signal-tag.vol{color:var(--warn);border-color:rgba(255,184,0,0.4);background:rgba(255,184,0,0.06);}
  .signal-tag.bb{color:#a78bfa;border-color:rgba(167,139,250,0.4);background:rgba(167,139,250,0.06);}
  .signal-tag.macd{color:var(--accent2);border-color:rgba(0,255,136,0.4);background:rgba(0,255,136,0.06);}
  .signal-tag.other{color:var(--muted);border-color:var(--border);}
  .alert-analysis{font-size:12px;color:var(--text);line-height:1.6;border-top:1px solid var(--border);padding-top:8px;margin-top:4px;}
  .alert-values{display:flex;gap:16px;flex-wrap:wrap;margin-top:6px;}
  .alert-val{font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--muted);}
  .alert-val span{color:var(--accent);}

  /* Filter */
  .filter-bar{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;}
  .filter-btn{font-family:'Share Tech Mono',monospace;font-size:10px;padding:6px 14px;border:1px solid var(--border);background:var(--surface);color:var(--muted);cursor:pointer;border-radius:2px;transition:all 0.15s;letter-spacing:1px;}
  .filter-btn:hover,.filter-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(0,212,255,0.06);}

  /* AI Summary */
  .ai-summary{background:rgba(0,212,255,0.04);border:1px solid rgba(0,212,255,0.2);border-radius:2px;padding:16px;margin-bottom:16px;font-size:13px;line-height:1.8;color:var(--text);display:none;}
  .ai-summary.visible{display:block;}
  .ai-summary-title{font-family:'Orbitron',monospace;font-size:11px;color:var(--accent);letter-spacing:2px;margin-bottom:10px;}

  .new-scan-btn{background:transparent;border:1px solid var(--border);color:var(--muted);font-family:'Share Tech Mono',monospace;font-size:10px;padding:6px 14px;cursor:pointer;letter-spacing:2px;transition:all 0.15s;}
  .new-scan-btn:hover{border-color:var(--accent);color:var(--accent);}

  .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--card);border:1px solid var(--accent2);color:var(--accent2);font-family:'Share Tech Mono',monospace;font-size:11px;letter-spacing:2px;padding:10px 20px;transition:transform 0.3s;z-index:100;}
  .toast.show{transform:translateX(-50%) translateY(0);}
  ::-webkit-scrollbar{width:4px;}
  ::-webkit-scrollbar-track{background:var(--bg);}
  ::-webkit-scrollbar-thumb{background:var(--border);}
</style>
</head>
<body>
<div class="container">

  <div class="header">
    <div class="header-badge">AI-POWERED MARKET INTELLIGENCE</div>
    <h1>APEX <span>SCANNER</span></h1>
    <div class="header-sub">CLAUDE AI + GEMINI AI ‚Äî CHOOSE YOUR ENGINE</div>
  </div>

  <div id="errorBox" style="display:none;background:rgba(255,51,102,0.1);border:1px solid var(--danger);border-radius:2px;padding:14px;margin-bottom:14px;font-family:'Share Tech Mono',monospace;font-size:11px;color:var(--danger);line-height:1.7;word-break:break-all;"></div>
  <div id="debugBox" style="display:none;background:rgba(0,212,255,0.04);border:1px solid rgba(0,212,255,0.2);border-radius:2px;padding:14px;margin-bottom:14px;font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--muted);line-height:1.8;word-break:break-all;white-space:pre-wrap;"></div>

  <div id="setupPanel">

    <!-- AI Engine -->
    <div class="section-label">00 ‚Äî SELECT AI ENGINE</div>
    <div class="card">
      <div class="engine-grid">
        <button class="engine-btn" id="engineClaude" onclick="selectEngine('claude')">
          <div class="engine-logo">ü§ñ</div>
          <div class="engine-name claude">CLAUDE</div>
          <div class="engine-desc">Anthropic's Claude Sonnet<br>Superior reasoning & analysis</div>
          <div class="engine-badge paid">$5 MIN CREDIT</div>
        </button>
        <button class="engine-btn active-gemini" id="engineGemini" onclick="selectEngine('gemini')">
          <div class="engine-logo">‚ú®</div>
          <div class="engine-name gemini">GEMINI</div>
          <div class="engine-desc">Gemini Flash via OpenRouter<br>Free tier, works everywhere</div>
          <div class="engine-badge free">FREE TIER AVAILABLE</div>
        </button>
      </div>
    </div>

    <!-- API Keys -->
    <div class="section-label">01 ‚Äî API KEY</div>
    <div class="card">
      <!-- Claude Key -->
      <div class="api-field" id="claudeField">
        <div class="api-label">CLAUDE API KEY</div>
        <input type="password" class="api-input" id="claudeKey"
               placeholder="sk-ant-... or sk-or-v1-..."
               oninput="saveKey('claude', this.value)" />
        <div class="api-actions">
          <button class="api-clear-btn" onclick="clearKey('claude')">‚úï CLEAR KEY</button>
          <a href="https://console.anthropic.com" target="_blank"
             style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);padding:5px 10px;border:1px solid rgba(0,212,255,0.3);text-decoration:none;">
            GET KEY ‚Üí
          </a>
        </div>
        <div class="api-note">Use your Anthropic key (sk-ant-...) from <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a>, or an OpenRouter key (sk-or-...) from <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a>.</div>
      </div>

      <!-- Gemini Key -->
      <div class="api-field visible" id="geminiField">
        <div class="api-label">GEMINI API KEY</div>
        <input type="password" class="api-input" id="geminiKey"
               placeholder="sk-or-v1-..."
               oninput="saveKey('gemini', this.value)" />
        <div class="api-actions">
          <button class="api-clear-btn" onclick="clearKey('gemini')">‚úï CLEAR KEY</button>
          <a href="https://aistudio.google.com/app/apikey" target="_blank"
             style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--accent);padding:5px 10px;border:1px solid rgba(0,212,255,0.3);text-decoration:none;">
            GET FREE KEY ‚Üí
          </a>
        </div>
        <div class="api-note">Paste your OpenRouter key (sk-or-...) from <a href="https://openrouter.ai/keys" target="_blank">openrouter.ai/keys</a> ‚Äî free tier available for Gemini Flash.</div>
      </div>

    </div>

    <!-- Markets -->
    <div class="section-label">02 ‚Äî SELECT MARKETS</div>
    <div class="card">
      <div class="market-grid">
        <button class="market-btn active" data-market="crypto_top500" onclick="toggleMarket(this)">
          <span class="icon">‚Çø</span><div class="name">CRYPTO TOP 500</div><div class="desc">By market cap</div>
        </button>
        <button class="market-btn" data-market="crypto_top1000" onclick="toggleMarket(this)">
          <span class="icon">ü™ô</span><div class="name">CRYPTO TOP 1000</div><div class="desc">By market cap</div>
        </button>
        <button class="market-btn" data-market="sp500" onclick="toggleMarket(this)">
          <span class="icon">üìà</span><div class="name">S&amp;P 500</div><div class="desc">US large cap</div>
        </button>
        <button class="market-btn" data-market="nasdaq100" onclick="toggleMarket(this)">
          <span class="icon">üíª</span><div class="name">NASDAQ 100</div><div class="desc">Tech index</div>
        </button>
        <button class="market-btn" data-market="russell2000" onclick="toggleMarket(this)">
          <span class="icon">üè≠</span><div class="name">RUSSELL 2000</div><div class="desc">Small cap</div>
        </button>
        <button class="market-btn" data-market="defi" onclick="toggleMarket(this)">
          <span class="icon">‚õì</span><div class="name">DEFI TOKENS</div><div class="desc">Top DeFi</div>
        </button>
      </div>
    </div>

    <!-- Indicators -->
    <div class="section-label">03 ‚Äî INDICATORS</div>
    <div class="card">
      <div class="ind-grid">
        <button class="ind-btn active" data-ind="WaveTrend" onclick="toggleInd(this)">
          <div class="ind-name">WAVETREND</div><div class="ind-desc">WT1 cross WT2 oversold</div><div class="ind-check">‚úì</div>
        </button>
        <button class="ind-btn active" data-ind="RSI Combo" onclick="toggleInd(this)">
          <div class="ind-name">RSI COMBO</div><div class="ind-desc">üü¢ green / üî¥ red dot signal</div><div class="ind-check">‚úì</div>
        </button>
        <button class="ind-btn" data-ind="MACD Crossover" onclick="toggleInd(this)">
          <div class="ind-name">MACD</div><div class="ind-desc">Bullish crossover</div><div class="ind-check"></div>
        </button>
        <button class="ind-btn" data-ind="Bollinger Band Lower Touch" onclick="toggleInd(this)">
          <div class="ind-name">BOLLINGER BANDS</div><div class="ind-desc">Price at lower band</div><div class="ind-check">‚úì</div>
        </button>
        <button class="ind-btn" data-ind="Stochastic RSI" onclick="toggleInd(this)">
          <div class="ind-name">STOCH RSI</div><div class="ind-desc">K cross D in oversold</div><div class="ind-check"></div>
        </button>
        <button class="ind-btn" data-ind="200 EMA proximity" onclick="toggleInd(this)">
          <div class="ind-name">200 EMA</div><div class="ind-desc">Price near 200 EMA</div><div class="ind-check"></div>
        </button>
        <button class="ind-btn" data-ind="Volume Spike" onclick="toggleInd(this)">
          <div class="ind-name">VOLUME SPIKE</div><div class="ind-desc">1.5x average surge</div><div class="ind-check">‚úì</div>
        </button>
        <button class="ind-btn" data-ind="VWAP" onclick="toggleInd(this)">
          <div class="ind-name">VWAP</div><div class="ind-desc">Anchored VWAP deviation</div><div class="ind-check"></div>
        </button>
        <button class="ind-btn" data-ind="ATR Expansion" onclick="toggleInd(this)">
          <div class="ind-name">ATR</div><div class="ind-desc">Volatility expansion</div><div class="ind-check"></div>
        </button>
        <button class="ind-btn" data-ind="OBV Rising" onclick="toggleInd(this)">
          <div class="ind-name">OBV</div><div class="ind-desc">Accumulation signal</div><div class="ind-check"></div>
        </button>
      </div>
    </div>

    <!-- Timeframe -->
    <div class="section-label">04 ‚Äî TIMEFRAME</div>
    <div class="card">
      <div style="display:flex;gap:8px;flex-wrap:wrap;" id="tfBtns">
        <button class="filter-btn" data-tf="4h" data-interval="4h" data-limit="300" onclick="selectTF(this)" title="4H: best for crypto. Stocks use 60m Yahoo data (limited history).">4H</button>
        <button class="filter-btn" data-tf="1d" data-interval="1d" data-limit="210" onclick="selectTF(this)">DAILY</button>
        <button class="filter-btn active" data-tf="1w" data-interval="1w" data-limit="210" onclick="selectTF(this)">WEEKLY</button>
      </div>
    </div>

    <!-- Thresholds -->
    <div class="section-label">04b ‚Äî THRESHOLDS</div>
    <div class="card">
      <div class="slider-grid">
        <div class="slider-item">
          <label>WT OVERSOLD <span id="wtVal">-45</span></label>
          <input type="range" min="-90" max="-20" value="-45" step="1" oninput="document.getElementById('wtVal').textContent=this.value">
        </div>
        <div class="slider-item">
          <label>RSI OVERSOLD <span id="rsiVal">40</span></label>
          <input type="range" min="10" max="50" value="40" step="1" oninput="document.getElementById('rsiVal').textContent=this.value">
        </div>
        <div class="slider-item">
          <label>VOLUME MULTIPLIER <span id="volVal">1.5x</span></label>
          <input type="range" min="10" max="50" value="15" step="1" oninput="document.getElementById('volVal').textContent=(this.value/10).toFixed(1)+'x'">
        </div>
        <div class="slider-item">
          <label>MIN CONDITIONS <span id="minVal">1</span></label>
          <input type="range" min="1" max="5" value="1" step="1" oninput="document.getElementById('minVal').textContent=this.value" id="minT">
        </div>
      </div>
    </div>

    <!-- Market Cap Filter -->
    <div class="section-label">04b ‚Äî STOCK MARKET CAP FILTER</div>
    <div class="card">
      <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--muted);margin-bottom:10px;">Only applies to stock markets. Crypto is unaffected.</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;" id="mcapBtns">
        <button class="filter-btn active" data-mcap="0" onclick="selectMcap(this)">ALL</button>
        <button class="filter-btn" data-mcap="200" onclick="selectMcap(this)">&lt; $200B</button>
        <button class="filter-btn" data-mcap="50" onclick="selectMcap(this)">&lt; $50B</button>
        <button class="filter-btn" data-mcap="10" onclick="selectMcap(this)">&lt; $10B</button>
        <button class="filter-btn" data-mcap="5" onclick="selectMcap(this)">&lt; $5B</button>
        <button class="filter-btn" data-mcap="1" onclick="selectMcap(this)">&lt; $1B</button>
      </div>
    </div>

    <!-- Telegram -->
  <!-- VWAP Anchor -->
  <div class="section-label">04c ‚Äî VWAP ANCHOR</div>
  <div class="card">
    <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--muted);margin-bottom:10px;">
      Crypto trades 24/7 ¬∑ Stocks trade Mon‚ÄìFri only. Choose lookback to match your timeframe.<br>
      <span style="color:var(--accent);">AUTO</span> = 52 bars weekly ¬∑ 200 bars daily ¬∑ smart per asset type.
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;" id="vwapAnchorBtns">
      <button class="filter-btn active" data-anchor="auto"   onclick="selectVwapAnchor(this)">AUTO</button>
      <button class="filter-btn" data-anchor="ytd"    onclick="selectVwapAnchor(this)">YTD</button>
      <button class="filter-btn" data-anchor="52"     onclick="selectVwapAnchor(this)">52 BARS</button>
      <button class="filter-btn" data-anchor="26"     onclick="selectVwapAnchor(this)">26 BARS</button>
      <button class="filter-btn" data-anchor="13"     onclick="selectVwapAnchor(this)">13 BARS</button>
      <button class="filter-btn" data-anchor="crypto" onclick="selectVwapAnchor(this)">CRYPTO 365d</button>
      <button class="filter-btn" data-anchor="stock"  onclick="selectVwapAnchor(this)">STOCK 252d</button>
    </div>
    <div style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--muted);margin-top:8px;" id="vwapAnchorDesc">
      AUTO: 52 bars on weekly (‚âà1yr), 200 bars on daily (‚âà9mo crypto / ‚âà8mo stocks)
    </div>
  </div>

  <div class="section-label">05 ‚Äî TELEGRAM ALERTS (OPTIONAL)</div>
  <div class="api-card">
    <div class="api-field visible">
      <div class="api-label">BOT TOKEN</div>
      <input type="password" class="api-input" id="tgToken" placeholder="123456789:ABCdef..." oninput="saveKey('tgToken',this.value)" />
    </div>
    <div class="api-field visible" style="margin-top:8px;">
      <div class="api-label">CHAT ID</div>
      <input type="text" class="api-input" id="tgChatId" placeholder="Your chat ID from @userinfobot" oninput="saveKey('tgChatId',this.value)" />
    </div>
    <div class="api-note" style="margin-top:6px;">Leave blank to skip. Get bot from @BotFather, chat ID from @userinfobot.</div>
    <button onclick="testTelegram()" style="margin-top:8px;background:transparent;border:1px solid #ffb800;color:#ffb800;font-family:Share Tech Mono,monospace;font-size:10px;padding:8px 16px;cursor:pointer;letter-spacing:2px;width:100%;">‚úâ TEST TELEGRAM</button>
    <div id="tgTestResult" style="display:none;margin-top:6px;font-family:Share Tech Mono,monospace;font-size:10px;padding:6px;"></div>
  </div>

  <button class="scan-btn" id="scanBtn" onclick="runScan()">‚ö° ANALYZE WITH AI</button>
  </div>

  <!-- Loading -->
  <div class="loading" id="loading">
    <div id="engineLabel">AI IS ANALYZING MARKETS...</div>
    <div class="loading-bar"></div>
    <div id="loadingStatus" style="font-size:10px;color:var(--muted);margin-top:8px;">Initializing...</div>
  </div>

  <!-- Results -->
  <div class="results-section" id="resultsSection">
    <div class="results-header">
      <div class="section-label" style="margin:0;flex:1">SCAN RESULTS</div>
      <button class="new-scan-btn" onclick="newScan()">‚Ü∫ NEW SCAN</button>
    </div>
    <div class="results-stats">
      <div class="stat-box"><div class="stat-val" id="statTotal">0</div><div class="stat-label">TOTAL</div></div>
      <div class="stat-box"><div class="stat-val" id="statStrong" style="color:var(--accent2)">0</div><div class="stat-label">STRONG</div></div>
      <div class="stat-box"><div class="stat-val" id="statMod" style="color:var(--warn)">0</div><div class="stat-label">MODERATE</div></div>
      <div class="stat-box"><div class="stat-val" id="statEngine" style="font-size:14px">‚Äî</div><div class="stat-label">AI ENGINE</div></div>
    </div>
    <div class="ai-summary" id="aiSummary">
      <div class="ai-summary-title">‚ö° AI MARKET ANALYSIS</div>
      <div id="aiSummaryText"></div>
    </div>
    <div class="filter-bar">
      <button class="filter-btn result-filter active" onclick="filterAlerts('all',this)">ALL</button>
      <button class="filter-btn result-filter" onclick="filterAlerts('strong',this)">üî• STRONG</button>
      <button class="filter-btn result-filter" onclick="filterAlerts('moderate',this)">‚ö° MODERATE</button>
      <button class="filter-btn result-filter" onclick="filterAlerts('crypto',this)">‚Çø CRYPTO</button>
      <button class="filter-btn result-filter" onclick="filterAlerts('stocks',this)">üìà STOCKS</button>
    </div>
    <div id="alertsContainer"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  let selectedEngine = 'gemini';
  let selectedMarkets = ['crypto_top500'];
  let selectedInds = ['WaveTrend','RSI Combo'];
  let allAlerts = [];
  let selectedMcap = 0;
  let selectedVwapAnchor = 'auto'; // auto | ytd | 52 | 26 | 13 | crypto | stock

  // ‚îÄ‚îÄ Per-session data cache ‚Äî avoids re-fetching on repeated scans ‚îÄ‚îÄ
  // Key: timeframe (1d/1w/4h), Value: {symbol: processedData}
  const DATA_CACHE = {};
  function getCacheKey(tf){ return tf; }
  let selectedTF = {tf:'1w', interval:'1w', limit:210, label:'1W'}; // 0 = no filter, otherwise max billion USD

  function selectMcap(btn) {
    document.querySelectorAll('#mcapBtns .filter-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    selectedMcap = parseFloat(btn.dataset.mcap);
  }

  function selectVwapAnchor(btn){
    document.querySelectorAll('#vwapAnchorBtns .filter-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    selectedVwapAnchor = btn.dataset.anchor;
    const descs = {
      'auto':   'AUTO: 52 bars on weekly (‚âà1yr), 200 bars on daily (‚âà9mo crypto / ‚âà8mo stocks)',
      'ytd':    'YTD: Anchored from Jan 1st of current year',
      '52':     '52 BARS: Last 52 candles regardless of timeframe or asset type',
      '26':     '26 BARS: Last 26 candles ‚Äî ~6 months on weekly',
      '13':     '13 BARS: Last 13 candles ‚Äî ~3 months on weekly',
      'crypto': 'CRYPTO 365d: 365 daily bars (~1 year) ‚Äî suits 24/7 crypto markets',
      'stock':  'STOCK 252d: 252 daily bars (~1 trading year) ‚Äî suits Mon‚ÄìFri stock markets'
    };
    document.getElementById('vwapAnchorDesc').textContent = descs[selectedVwapAnchor] || '';
  }

  function selectTF(btn) {
    document.querySelectorAll('#tfBtns .filter-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    selectedTF = {
      tf: btn.dataset.tf,
      interval: btn.dataset.interval,
      limit: parseInt(btn.dataset.limit),
      label: btn.dataset.tf==='1w'?'1W': btn.dataset.tf==='1d'?'1D':'4H'
    };
    // Auto-adjust thresholds for timeframe ‚Äî weekly bars are smoother so WT/RSI
    // oscillate in a tighter range; daily/4H are more volatile
    const isWeekly = btn.dataset.tf === '1w';
    const wtSlider = document.getElementById('wtSlider');
    const wtValEl  = document.getElementById('wtVal');
    const rsiSlider = document.querySelector('input[type=range][oninput*="rsiVal"]');
    const rsiValEl  = document.getElementById('rsiVal');
    if(wtSlider && wtValEl){
      const wtDefault = isWeekly ? '-30' : '-45';
      wtSlider.value = wtDefault;
      wtValEl.textContent = wtDefault;
    }
    if(rsiSlider && rsiValEl){
      const rsiDefault = isWeekly ? '45' : '40';
      rsiSlider.value = rsiDefault;
      rsiValEl.textContent = rsiDefault;
    }
    // Warn about Volume Spike on weekly (incomplete current candle)
    if(isWeekly){
      showToast('1W: WT threshold auto-set to -30 (weekly bars are smoother)');
    }
  }

  const MARKET_TICKERS = {
    crypto_top500:{label:'Crypto Top 500',type:'crypto',tickers:['BTC','ETH','BNB','XRP','SOL','ADA','DOGE','TRX','DOT','LTC','SHIB','AVAX','LINK','ATOM','UNI','XLM','BCH','ALGO','ICP','HBAR','APT','ARB','NEAR','GRT','AAVE','MKR','INJ','OP','SUI','SEI','TIA','RUNE','PENDLE','JUP','WIF','BONK','FLOKI','PEPE','TON','KAS','TAO','IMX','RNDR','FIL','THETA','EGLD','FLOW','MINA','SAND','MANA','AXS','CHZ','ENJ','GALA','APE','GMT','GMX','DYDX','LDO','CRV','COMP','BAL','YFI','SUSHI','CVX','STX','BLUR','HNT','KDA','KAVA','ROSE','ANKR','RVN','ZIL','ZEC','DASH','XMR','ETC','NEO','VET','SNX','1INCH','CAKE','BAND','ASTR','CFX','CORE','ACH','RAY','ORCA','FTM','MAGIC','GMX','PENDLE','ARB','OP','INJ','TIA','SEI','SUI','JUP','WIF','BONK','PYTH','JTO','TNSR','W','STRK','MANTA','ALT','PIXEL','PORTAL','ZKFAIR','METIS','BICO','API3','PERP','DYDX','SNX','UMA','BAL','POND','MASK','ALICE','TLM','QUICK','DODO','REEF','COMBO','FARM','BANK','POLS','SUPER','GHST','NEAR','ROSE','MOVR','GLMR','KSM','ACA','PARA','ASTR','SDN','BNC','KINT','AIR','KAR','CSM','PHA','TEER','RING','CRUST','DEGO','ERG','CKB','FORCE','VSYS','KMD','ARDR','IGNIS','NXT','BURST','XCP','MONA','VIA','GAME','NLG','BLOCK','HTML','XMY','MUSIC','CREA','XST','NXS','UNO','GRC','OKCASH','BLK','FLASH','TRIG','SPHR','LINX','SIB','KORE','NYC','EDRC','CHC','BTA','VRC','MEC','EFL','TOPAZ','VRM','ION','AMBER','LBRY','DBET','PLR','SAN','PAI','MDA','BRD','POE','EVX','SALT','RCN','DNT','AST','CDT','SNGLS','LRC','ENG','REQ','VIB','POWR','WTC','QSP','APPC','WABI','YOYO','OST','SUB','TNT','GTO','ZRX','SNT','ANT','BAT','FUN','OMG','NMR','CVC','BNT','STORJ','AMB','ELF','ENJ','KNC','MTL','NAS','OAX','PAY','POE','RLC','RPX','SNGLS','SNM','SPANK','SRN','TNB','VEN','XVG','ZEN','WAVES','DCR','QTUM','BTG','ICX','ONT','IOTA','LSK','ARK','ZEC','XEM','FCT'].slice(0,500)},
    crypto_top1000:{label:'Crypto Top 1000',type:'crypto',tickers:['BTC','ETH','BNB','XRP','SOL','ADA','DOGE','TRX','DOT','LTC','SHIB','AVAX','LINK','ATOM','UNI','XLM','BCH','ALGO','ICP','HBAR','APT','ARB','NEAR','GRT','AAVE','MKR','INJ','OP','SUI','SEI','TIA','RUNE','PENDLE','JUP','WIF','BONK','FLOKI','PEPE','TON','KAS','TAO','IMX','RNDR','FIL','THETA','EGLD','FLOW','MINA','SAND','MANA','AXS','CHZ','ENJ','GALA','APE','GMT','GMX','DYDX','LDO','CRV','COMP','BAL','YFI','SUSHI','CVX','STX','BLUR','HNT','KDA','KAVA','ROSE','ANKR','RVN','ZIL','ZEC','DASH','XMR','ETC','NEO','VET','SNX','1INCH','CAKE','BAND','ASTR','CFX','CORE','ACH','RAY','ORCA','FTM','MAGIC','GMX','PENDLE','ARB','OP','INJ','TIA','SEI','SUI','JUP','WIF','BONK','PYTH','JTO','TNSR','W','STRK','MANTA','ALT','PIXEL','PORTAL','ZKFAIR','METIS','BICO','API3','PERP','DYDX','SNX','UMA','BAL','POND','MASK','ALICE','TLM','QUICK','DODO','REEF','COMBO','FARM','BANK','POLS','SUPER','GHST','NEAR','ROSE','MOVR','GLMR','KSM','ACA','PARA','ASTR','SDN','BNC','KINT','AIR','KAR','CSM','PHA','TEER','RING','CRUST','DEGO','ERG','CKB','FORCE','VSYS','KMD','ARDR','IGNIS','NXT','BURST','XCP','MONA','VIA','GAME','NLG','BLOCK','HTML','XMY','MUSIC','CREA','XST','NXS','UNO','GRC','OKCASH','BLK','FLASH','TRIG','SPHR','LINX','SIB','KORE','NYC','EDRC','CHC','BTA','VRC','MEC','EFL','TOPAZ','VRM','ION','AMBER','LBRY','DBET','PLR','SAN','PAI','MDA','BRD','POE','EVX','SALT','RCN','DNT','AST','CDT','SNGLS','LRC','ENG','REQ','VIB','POWR','WTC','QSP','APPC','WABI','YOYO','OST','SUB','TNT','GTO','ZRX','SNT','ANT','BAT','FUN','OMG','NMR','CVC','BNT','STORJ','AMB','ELF','ENJ','KNC','MTL','NAS','OAX','PAY','POE','RLC','RPX','SNGLS','SNM','SPANK','SRN','TNB','VEN','XVG','ZEN','WAVES','DCR','QTUM','BTG','ICX','ONT','IOTA','LSK','ARK','ZEC','XEM','FCT']}, // upgraded live from CoinGecko
    sp500:{label:'S&P 500',type:'stock',tickers:['AAPL','MSFT','AMZN','NVDA','GOOGL','META','TSLA','BRK-B','UNH','LLY','JPM','V','XOM','MA','PG','JNJ','HD','AVGO','MRK','CVX','PEP','ABBV','COST','KO','WMT','ADBE','CRM','BAC','MCD','PFE','TMO','CSCO','ABT','ACN','NKE','DHR','LIN','CMCSA','TXN','VZ','PM','NEE','RTX','HON','AMGN','IBM','UNP','INTC','QCOM','INTU','SBUX','GE','LOW','AMD','CAT','DE','SPGI','MS','GS','BLK']},
    nasdaq100:{label:'Nasdaq 100',type:'stock',tickers:['AAPL','MSFT','AMZN','NVDA','GOOGL','GOOG','META','TSLA','AVGO','ADBE','CSCO','CMCSA','INTC','AMD','INTU','QCOM','HON','AMAT','SBUX','MDLZ','GILD','REGN','VRTX','ISRG','KLAC','LRCX','SNPS','CDNS','MRVL','PANW','CRWD','NFLX','PYPL','ADP','MELI','ASML','COST','PDD','KDP','ORLY','PCAR','CTAS','FTNT','FAST','CPRT','MNST','DDOG','ROST','PAYX','ODFL']},
    russell2000:{label:'Russell 2000',type:'stock',tickers:[
      // Technology
      'SMCI','RMBS','ACLS','SPSC','ALRM','FORM','PRGS','MGNI','ITRI','PLXS','NSIT','CARG','DFIN',
      'IRTC','KTOS','AEIS','CABO','POWI','CSGS','TNET','QTWO','AMSF','EBIX','PLUS','CDNA','AGIO',
      'CNXN','INVA','RELY','BAND','EVBG','DOMO','LPSN','TDOC','MIME','ATEN','DDOG','APPN','HUBS',
      'ALKT','JAMF','PAYA','BRZE','WEAV','TASK','AGYS','AMSWA','CCSI','SCSC','PCTY','PAYC',
      'NCNO','AVLR','LMNX','NUAN','QDEL','RBBN','SANM','SMAR','OSPN','NTNX','PUBM','TRMK',
      // Healthcare / Biotech
      'HALO','TGTX','PTCT','NEOG','CPRX','AORT','PAHC','MGPI','HTLF','IDEX','MSGS','SFBS',
      'ACAD','AKRO','ALNY','ANAB','APLS','ARWR','ATRC','AXNX','BCYC','BHVN','BIKE','BMRN',
      'CABA','CARA','CCCC','CHMA','CNMD','COHU','CPRX','CRSP','CTLT','DAWN','DBTX','DCPH',
      'EDIT','EIDX','ELAN','ELYM','ENOV','EPZM','ERAS','ESPR','EWTX','EXAS','FATE','FGEN',
      'FOLD','FWBI','GKOS','GNMK','GOSS','HALO','HIMS','HOOK','HRMY','ICAD','ICLR','IDYA',
      'IMCR','IMGN','INVA','IONS','IOVA','IRHQ','IRMD','ISEE','ITCI','JAZZ','KALA','KDNY',
      'KPTI','KROS','KYMR','LBPH','LGND','LNTH','LUNG','MGNX','MGTA','MORF','MRNS','MRUS',
      'NKTR','NMRA','NRIX','NTLA','NVAX','NVCR','NVRO','NWBO','OCUL','OFIX','ONCE','OPCH',
      'ORGO','ORMP','OSMT','PCRX','PDCO','PHAT','PRAX','PRLD','PRTA','PTGX','PTLO','RCKT',
      'RGEN','RLMD','RLYB','RPRX','RUBY','RXRX','RZLT','SAGE','SANA','SBGI','SEER','SENS',
      'SERA','SGEN','SGMO','SHPH','SIGA','SIOX','SLDB','SMMT','SNDX','SNGX','SPNV','SRPT',
      'STOK','STRO','SURF','SVRA','SWAV','SYNH','TARS','TBPH','TCMD','TERN','TGTX','TILS',
      'TLRY','TMDX','TNXP','TPVG','TRIL','TRTX','TRUP','TTOO','TVTX','TXMD','TYRA','UCTT',
      'URGN','USPH','UTRS','VACC','VCNX','VERY','VKTX','VNDA','VRDN','VRTX','VTRS','WKHS',
      // Financials / Banks
      'SFBS','HTLF','MYRG','RELY','HTLD','LQDT','CNXN','DXPE','REPX','ARCH',
      'ABCB','ACNB','AGIO','AMNB','AMTB','ASRV','ATLO','AUBN','BANF','BANR','BCAL','BCBP',
      'BCSB','BFIN','BFST','BGCP','BHLB','BMTC','BOCH','BPFH','BRKL','BSVN','BUSE','BYFC',
      'CADE','CBAN','CBFV','CBNK','CCBG','CFFN','CFFI','CHMG','CHCO','CIVB','CIZN','CLBK',
      'CNOB','CODI','COLB','CTBI','CZWI','DCOM','EFSC','EGBN','EMCF','ESSA','EVBN','EVLO',
      'FBIZ','FBMS','FBNC','FBSS','FCCO','FCNCA','FDEF','FDBC','FFBC','FFBH','FFIC','FFIN',
      'FGBI','FISI','FLIC','FLMN','FLY','FMAO','FMBH','FMBI','FMNB','FNGR','FNWB','FNWD',
      'FRBA','FRME','FSBW','FULT','FUNC','FXNC','GABC','GCBC','GFED','GLDD','GNBC','GNTY',
      'GRWG','GSBC','GTBP','GVP','HAFC','HBAN','HBCP','HBMD','HCAT','HFWA','HGBL','HLAN',
      // Industrials
      'SAIA','GTLS','CSWI','UFPI','ESAB','AAON','HLIO','DNOW','BOOT','INVA',
      'AEIS','ACMR','ACCO','AEIS','AGCO','AIMC','AJAX','ALCO','ALGT','ALGM','ALGT','ALRM',
      'AMWD','APOG','ARCB','ARKO','ASIX','ATSG','AVAV','AXTA','AZPN','BCPC','BFAM','BLDP',
      'BLMN','BLTH','BMBL','BRBR','BRBS','BRKR','BSIG','BSMX','BSTC','BURL','BWXT','CAKE',
      'CALM','CATO','CBRL','CBUS','CCAP','CCRN','CDLX','CECO','CENT','CEVA','CFLT','CGEN',
      'CGNT','CHCT','CHEF','CHGG','CHRS','CLFD','CLLS','CLMT','CLPR','CLPS','CLVT','CMCO',
      'CMPR','CMRE','CNDT','CNXC','COHU','COOP','CORE','CORT','CPRI','CPRT','CRDO','CRNX',
      'CRTO','CRUS','CSII','CSTE','CSTM','CSWC','CTAS','CTGO','CTKB','CTRL','CURO','CXDO',
      // Energy
      'CHRD','ARCH','REPX','DNOW',
      'AMPY','BATL','BORR','CEIX','CELP','CLNE','CLR','CODI','CPEN','CPE','CRIS','CRZO',
      'DINO','DKL','DNN','DRIL','DRQ','EMAN','ENVA','EPIC','ESTE','FLMN','FLY','FMSA',
      'GPOR','GPRK','GRNT','GTXO','GXII','HESM','HTGC','HUSA','INDO','INFU','IPIX','IRDM',
      'JAGX','JBLU','JOUT','JOBY','JSPR','KALEYRA','KBAL','KELYA','KFRC','KLIC','KMDA',
      'KNBE','KNTK','KPLT','KRNY','KRTX','KSCP','KYMR','LBAI','LCII','LCUT','LDOS','LEGH',
      // Consumer / Retail
      'BOOT','PZZA','MSGS','CARG','MGPI',
      'ACMR','ACVA','ADUS','AEHR','AEMD','AESI','AEVA','AFCG','AFRI','AGIO','AGMH','AGRI',
      'AGTC','AGTI','AGUS','AGYS','AHCO','AHPI','AIOT','AIRG','AIRSP','AIXI','AJRD','AKAM',
      'AKBA','AKLI','AKTS','AKUS','ALBO','ALCO','ALDX','ALEC','ALEX','ALGT','ALIM','ALJJ',
      'ALLK','ALLT','ALLR','ALLT','ALMG','ALNT','ALOT','ALPA','ALRM','ALRS','ALSN','ALTI',
      'ALTR','ALTU','ALVR','ALXO','ALYA','AMAG','AMBC','AMBO','AMBU','AMCI','AMCX','AMEH',
      'AMGN','AMHC','AMID','AMIX','AMKR','AMNB','AMOT','AMPH','AMPL','AMRK','AMRN','AMRS',
      'AMSC','AMSF','AMST','AMTB','AMTD','AMTI','AMTX','AMWD','AMWL','AMYT','ANAB','ANAL',
      // More diversified small caps
      'ABSI','ABST','ABT','ACBI','ACCD','ACET','ACGLO','ACHC','ACHV','ACIC','ACII','ACLS',
      'ACMR','ACNB','ACOR','ACRS','ACRV','ACRX','ACST','ACTG','ACVA','ACVF','ACWI','ACXM',
      'ADAP','ADBE','ADEN','ADEX','ADGM','ADIL','ADIT','ADIX','ADMA','ADMP','ADMS','ADNT',
      'ADOC','ADPT','ADRA','ADRB','ADRO','ADSK','ADTN','ADTX','ADUS','ADVM','ADXN','AEAC',
      'AEAEU','AEHR','AEIS','AELX','AEMD','AENZ','AERI','AESI','AEVA','AEVH','AFAR','AFBI',
      'AFCG','AFGE','AFGH','AFGL','AFIB','AFIN','AFMB','AFMD','AFRI','AFRM','AFTR','AFYA'
    ]},
    defi:{label:'DeFi Tokens',type:'crypto',tickers:null} // fetched live
  };

  // Stablecoins and wrapped tokens to exclude from crypto scans
  const EXCLUDE_SYMBOLS = new Set(['USDT','USDC','BUSD','TUSD','USDD','USDP','FDUSD','DAI','FRAX','LUSD','PYUSD','GUSD','SUSD','USDB','USDX','EURC','WBTC','WETH','WBNB','STETH','WSTETH','CBETH','RETH','BETH','SOLVBTC','BTCB','HBTC','RENBTC']);

  // ‚îÄ‚îÄ Fetch live top-N crypto from CoinGecko ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function fetchLiveCryptoList(limit){
    const pages=Math.ceil(limit/250);
    const symbols=[];
    for(let p=1;p<=pages;p++){
      try{
        const perPage=Math.min(250,limit-(p-1)*250);
        const url=`https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=${perPage}&page=${p}&sparkline=false`;
        const res=await fetch(url);
        if(!res.ok) break;
        const data=await res.json();
        data.forEach(coin=>{
          const sym=coin.symbol.toUpperCase();
          if(!EXCLUDE_SYMBOLS.has(sym)) symbols.push(sym);
        });
      }catch(e){ break; }
    }
    return symbols;
  }

  // ‚îÄ‚îÄ Engine selection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function selectEngine(engine) {
    selectedEngine = engine;
    document.getElementById('engineClaude').className = 'engine-btn' + (engine==='claude' ? ' active-claude' : '');
    document.getElementById('engineGemini').className = 'engine-btn' + (engine==='gemini' ? ' active-gemini' : '');
    document.getElementById('claudeField').className = 'api-field' + (engine==='claude' ? ' visible' : '');
    document.getElementById('geminiField').className = 'api-field' + (engine==='gemini' ? ' visible' : '');
  }

  // ‚îÄ‚îÄ Key storage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function saveKey(engine, val) {
    try { localStorage.setItem('apex_key_'+engine, val); } catch(e) {}
  }

  function clearKey(engine) {
    try {
      localStorage.removeItem('apex_key_'+engine);
      document.getElementById(engine+'Key').value = '';
      showToast('KEY CLEARED');
    } catch(e) {}
  }

  function loadKeys() {
    try {
      const ck = localStorage.getItem('apex_key_claude');
      const gk = localStorage.getItem('apex_key_gemini');
      if (ck) document.getElementById('claudeKey').value = ck;
      if (gk) document.getElementById('geminiKey').value = gk;
      const tgt=localStorage.getItem('apex_key_tgToken');
      const tgc=localStorage.getItem('apex_key_tgChatId');
      if(tgt&&document.getElementById('tgToken')) document.getElementById('tgToken').value=tgt;
      if(tgc&&document.getElementById('tgChatId')) document.getElementById('tgChatId').value=tgc;
    } catch(e) {}
  }

  window.addEventListener('load', loadKeys);

  // ‚îÄ‚îÄ Market / indicator toggles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function toggleMarket(btn) {
    btn.classList.toggle('active');
    const m = btn.dataset.market;
    selectedMarkets = selectedMarkets.includes(m) ? selectedMarkets.filter(x=>x!==m) : [...selectedMarkets,m];
  }

  function toggleInd(btn) {
    btn.classList.toggle('active');
    const ind = btn.dataset.ind;
    const check = btn.querySelector('.ind-check');
    if (selectedInds.includes(ind)) { selectedInds=selectedInds.filter(x=>x!==ind); check.textContent=''; }
    else { selectedInds.push(ind); check.textContent='‚úì'; }
  }

  // ‚îÄ‚îÄ On-screen debug log (visible without DevTools) ‚îÄ‚îÄ
  const _debugLines = [];
  function debugLog(...args){
    const msg = args.map(a=>typeof a==='object'?JSON.stringify(a):String(a)).join(' ');
    console.log('[APEX]', msg);
    _debugLines.push(msg);
    const box = document.getElementById('debugBox');
    if(box){ box.style.display='block'; box.textContent = _debugLines.slice(-30).join('\n'); }
  }

  function showToast(msg) {
    const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show');
    setTimeout(()=>t.classList.remove('show'),8000);
  }

  function showError(msg) {
    const box = document.getElementById('errorBox');
    box.textContent = msg;
    box.style.display = 'block';
    document.getElementById('loading').classList.remove('visible');
    document.getElementById('setupPanel').style.display = 'block';
  }

  function newScan() {
    document.getElementById('resultsSection').classList.remove('visible');
    document.getElementById('setupPanel').style.display='block';
    allAlerts=[];
  }

  // ‚îÄ‚îÄ API calls via OpenRouter (no backend needed) ‚îÄ‚îÄ‚îÄ‚îÄ
  async function callAI(prompt) {
    const keyFieldId = selectedEngine === 'claude' ? 'claudeKey' : 'geminiKey';
    const apiKey = document.getElementById(keyFieldId).value.trim();
    if (!apiKey) throw new Error('Enter your ' + (selectedEngine === 'claude' ? 'Claude' : 'Gemini') + ' API key in Section 01');

    // Anthropic direct (sk-ant-...)
    if (apiKey.startsWith('sk-ant-')) {
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-haiku-4-5-20251001',
          max_tokens: 4096,
          messages: [{ role: 'user', content: prompt }]
        })
      });
      const rawText = await response.text();
      let data;
      try { data = JSON.parse(rawText); } catch(e) { throw new Error('Invalid response: ' + rawText.substring(0,200)); }
      if (!response.ok || data.error) throw new Error(data.error?.message || 'Anthropic API error');
      return data.content[0].text;
    }

    // OpenRouter fallback (sk-or-...)
    const model = selectedEngine === 'claude' ? 'anthropic/claude-haiku-4-5-20251001' : 'google/gemini-2.0-flash-exp:free';
    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + apiKey,
        'HTTP-Referer': 'https://apex-scanner.app',
        'X-Title': 'APEX SCANNER'
      },
      body: JSON.stringify({ model, max_tokens: 4096, messages: [{ role: 'user', content: prompt }] })
    });
    const rawText = await response.text();
    let data;
    try { data = JSON.parse(rawText); } catch(e) { throw new Error('Invalid response: ' + rawText.substring(0,200)); }
    if (!response.ok || data.error) throw new Error(data.error?.message || JSON.stringify(data.error) || 'API error');
    return data.choices[0].message.content;
  }

  // ‚îÄ‚îÄ AI call with web search enabled (Claude direct only) ‚îÄ‚îÄ
  async function callAIWithSearch(prompt) {
    const apiKey = document.getElementById(selectedEngine==='claude'?'claudeKey':'geminiKey').value.trim();
    // Web search only available on Anthropic direct API
    if(apiKey.startsWith('sk-ant-')){
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKey,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-haiku-4-5-20251001',
          max_tokens: 4096,
          tools: [{ type: 'web_search_20250305', name: 'web_search' }],
          messages: [{ role: 'user', content: prompt }]
        })
      });
      const rawText = await response.text();
      let data;
      try { data = JSON.parse(rawText); } catch(e) { throw new Error('Invalid response: ' + rawText.substring(0,200)); }
      if(!response.ok || data.error) throw new Error(data.error?.message || 'Anthropic API error');
      // Extract all text blocks from response (may include tool_use + tool_result + final text)
      const textBlocks = (data.content||[]).filter(b=>b.type==='text').map(b=>b.text);
      return textBlocks.join('');
    }
    // Fallback to regular call for OpenRouter/Gemini (no web search support)
    return callAI(prompt);
  }

  // ‚îÄ‚îÄ Telegram functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function testTelegram() {
    const token=document.getElementById('tgToken').value.trim();
    const chatId=document.getElementById('tgChatId').value.trim();
    const result=document.getElementById('tgTestResult');
    result.style.display='block';
    if(!token){result.style.color='#ff3366';result.textContent='ERROR: Enter bot token first';return;}
    if(!chatId){result.style.color='#ff3366';result.textContent='ERROR: Enter chat ID first';return;}
    result.style.color='#ffb800';result.textContent='Testing...';
    try{
      const botRes=await fetch('https://api.telegram.org/bot'+token+'/getMe');
      const botData=await botRes.json();
      if(!botData.ok){result.style.color='#ff3366';result.textContent='ERROR: Invalid bot token. Get from @BotFather';return;}
      const parsedId=isNaN(chatId)?chatId:parseInt(chatId);
      const msgRes=await fetch('https://api.telegram.org/bot'+token+'/sendMessage',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({chat_id:parsedId,text:'APEX SCANNER: Connection test successful!'})
      });
      const msgData=await msgRes.json();
      if(msgData.ok){result.style.color='#00ff88';result.textContent='SUCCESS! Check your Telegram for the test message.';}
      else{result.style.color='#ff3366';result.textContent='ERROR: '+msgData.description+' ‚Äî Check your Chat ID';}
    }catch(e){result.style.color='#ff3366';result.textContent='ERROR: '+e.message;}
  }

  async function sendTelegram(alerts,sentimentMap,liqData){
    const token=document.getElementById('tgToken').value.trim();
    const chatId=document.getElementById('tgChatId').value.trim();
    if(!token||!chatId) return;
    const parsedId=isNaN(chatId)?chatId:parseInt(chatId);
    const strong=alerts.filter(a=>a.score>=3);
    if(strong.length===0) return;
    let msg='APEX SCANNER RESULTS\n'+new Date().toLocaleString()+'\n\nSTRONG SIGNALS ('+strong.length+'):\n\n';
    strong.forEach(a=>{
      msg+=a.symbol+' - '+a.score+' signals\n';
      msg+='Signals: '+(a.signals||[]).join(', ')+'\n';
      if(sentimentMap&&sentimentMap[a.symbol]) msg+='Reddit: '+sentimentMap[a.symbol].label+' ('+sentimentMap[a.symbol].posts+' posts)\n';
      const liq=liqData&&liqData[a.symbol];
      if(liq&&liq.alert) msg+='LIQ ZONE: '+(liq.alertType==='NEAR_LONG_LIQ'?'Long':'Short')+' '+(liq.alertType==='NEAR_LONG_LIQ'?liq.distLong:liq.distShort)+'% away | Funding: '+liq.bias+'\n';
      msg+='\n';
    });
    // Split into chunks
    const chunks=[];
    while(msg.length>4000){chunks.push(msg.substring(0,4000));msg=msg.substring(4000);}
    chunks.push(msg);
    for(const chunk of chunks){
      try{
        await fetch('https://api.telegram.org/bot'+token+'/sendMessage',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({chat_id:parsedId,text:chunk})
        });
      }catch(e){console.log('Telegram error:',e);}
    }
  }

  // ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function getSignalClass(s) {
    s=s.toLowerCase();
    if(s.includes('wt')||s.includes('wave')) return 'wt';
    if(s.includes('rsi')) return 'rsi';
    if(s.includes('vol')) return 'vol';
    if(s.includes('bb')||s.includes('bolling')) return 'bb';
    if(s.includes('macd')) return 'macd';
    return 'other';
  }

  function renderAlerts(alerts) {
    const c=document.getElementById('alertsContainer');
    c.innerHTML='';
    if(alerts.length===0){
      c.innerHTML='<div style="text-align:center;padding:40px;font-family:Share Tech Mono,monospace;font-size:12px;color:var(--muted);">NO ALERTS FOR CURRENT FILTER</div>';
      return;
    }
    alerts.forEach(function(a){
      const isStrong=a.score>=3;
      const card=document.createElement('div');
      card.className='alert-card '+(isStrong?'strong':'moderate');
      card.dataset.type=a.type||'';
      card.dataset.strength=isStrong?'strong':'moderate';
      const signals=a.signals||[];
      let sigsHtml='';
      signals.forEach(function(s){
        const label=s.includes(':')?s.split(':').slice(1).join(':'):s;
        sigsHtml+='<span class="signal-tag '+getSignalClass(label)+'">'+label+'</span>';
      });

      // Reddit sentiment badge
      let sentHtml='';
      if(a.sentiment){
        const clr=a.sentimentEmoji==='green'?'color:#00ff88;border-color:rgba(0,255,136,0.4);background:rgba(0,255,136,0.06)':
                  a.sentimentEmoji==='red'?'color:#ff3366;border-color:rgba(255,51,102,0.4);background:rgba(255,51,102,0.06)':
                  'color:#ffb800;border-color:rgba(255,184,0,0.4);background:rgba(255,184,0,0.06)';
        sentHtml='<div style="margin-top:8px;font-family:Share Tech Mono,monospace;font-size:10px;padding:4px 10px;display:inline-block;border-radius:2px;border:1px solid;'+clr+'">REDDIT: '+a.sentiment+'</div>';
      }

      // Liquidation proximity (always show for crypto if data exists)
      let liqHtml='';
      if(a.distLong!==undefined){
        const longColor=a.distLong<=8?'#ff3366':a.distLong<=15?'#ffb800':'#4a6070';
        const shortColor=a.distShort<=8?'#ff3366':a.distShort<=15?'#ffb800':'#4a6070';
        const nearWarn=a.nearLiq?'<span style="color:#ff3366;margin-left:8px;font-size:9px;animation:pulse-border 1s infinite;">‚ö† NEAR LIQ</span>':'';
        const biasColor=a.fundingBias==='LONGS_CROWDED'?'#ff6b35':a.fundingBias==='SHORTS_CROWDED'?'#00ff88':'#4a6070';
        liqHtml=
          '<div style="margin-top:8px;padding:8px 10px;border:1px solid #0e2033;border-radius:2px;background:rgba(255,51,102,0.03);">'+
            '<div style="font-family:Share Tech Mono,monospace;font-size:9px;color:var(--muted);letter-spacing:2px;margin-bottom:6px;">LIQ ZONES'+nearWarn+'</div>'+
            '<div style="display:flex;gap:16px;flex-wrap:wrap;">'+
              '<div style="font-family:Share Tech Mono,monospace;font-size:10px;">üî¥ LONG LIQ <span style="color:'+longColor+';">'+a.distLong+'% below</span></div>'+
              '<div style="font-family:Share Tech Mono,monospace;font-size:10px;">üü¢ SHORT LIQ <span style="color:'+shortColor+';">'+a.distShort+'% above</span></div>'+
              '<div style="font-family:Share Tech Mono,monospace;font-size:10px;">FUNDING <span style="color:'+biasColor+';">'+a.fundingBias+'</span></div>'+
            '</div>'+
          '</div>';
      }

      // RSI Combo badges
      let rsiComboHtml='';
      if(a.rsiCombo){
        const rc=a.rsiCombo;
        const badges=[];
        if(rc.mup)   badges.push('<span style="font-family:Share Tech Mono,monospace;font-size:9px;padding:3px 8px;border-radius:2px;border:1px solid;color:#00ff88;border-color:rgba(0,255,136,0.4);background:rgba(0,255,136,0.08);">üü¢ RSI GREEN DOT ‚Äî Bullish Exhaustion</span>');
        if(rc.mdown) badges.push('<span style="font-family:Share Tech Mono,monospace;font-size:9px;padding:3px 8px;border-radius:2px;border:1px solid;color:#ff3366;border-color:rgba(255,51,102,0.4);background:rgba(255,51,102,0.08);">üî¥ RSI RED DOT ‚Äî Bearish Exhaustion</span>');
        if(badges.length) rsiComboHtml='<div style="display:flex;flex-wrap:wrap;gap:5px;margin-top:7px;">'+badges.join('')+'</div>';
      }
      const isLive = a.dataSource === 'live';
      const dataBadge = '<span style="font-family:Share Tech Mono,monospace;font-size:8px;padding:2px 7px;border-radius:2px;border:1px solid;margin-left:8px;'+(isLive?'color:#00ff88;border-color:rgba(0,255,136,0.4);background:rgba(0,255,136,0.06)':'color:#ffb800;border-color:rgba(255,184,0,0.4);background:rgba(255,184,0,0.06)')+'">'+(isLive?'‚óè LIVE':'‚óå AI EST')+'</span>';

      // Build research HTML outside of string concatenation
      let researchHtml = '';
      if(a.verdict) {
        const vColor  = a.verdict==='STRONG'?'#00ff88':a.verdict==='WEAK'?'#ff3366':'#ffb800';
        const vBg     = a.verdict==='STRONG'?'rgba(0,255,136,0.06)':a.verdict==='WEAK'?'rgba(255,51,102,0.06)':'rgba(255,184,0,0.06)';
        const vBorder = a.verdict==='STRONG'?'rgba(0,255,136,0.3)':a.verdict==='WEAK'?'rgba(255,51,102,0.3)':'rgba(255,184,0,0.3)';
        researchHtml =
          '<div style="margin-top:10px;padding:10px 12px;border:1px solid #0e2033;border-radius:2px;background:rgba(0,212,255,0.02);">'+
            '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">'+
              '<span style="font-family:Share Tech Mono,monospace;font-size:9px;color:var(--muted);letter-spacing:2px;">AI RESEARCH</span>'+
              '<span style="font-family:Share Tech Mono,monospace;font-size:9px;padding:2px 8px;border-radius:2px;border:1px solid '+vBorder+';color:'+vColor+';background:'+vBg+';">'+a.verdict+'</span>'+
            '</div>'+
            (a.fundamentals ? '<div style="margin-bottom:6px;"><span style="font-family:Share Tech Mono,monospace;font-size:9px;color:var(--accent);letter-spacing:1px;">FUNDAMENTALS </span><span style="font-size:11px;color:var(--text);line-height:1.5;">'+a.fundamentals+'</span></div>' : '')+
            (a.disruptive   ? '<div style="margin-bottom:6px;"><span style="font-family:Share Tech Mono,monospace;font-size:9px;color:#7b4dff;letter-spacing:1px;">TECH/INNOVATION </span><span style="font-size:11px;color:var(--text);line-height:1.5;">'+a.disruptive+'</span></div>' : '')+
            (a.news         ? '<div><span style="font-family:Share Tech Mono,monospace;font-size:9px;color:var(--warn);letter-spacing:1px;">RECENT NEWS </span><span style="font-size:11px;color:var(--text);line-height:1.5;">'+a.news+'</span></div>' : '')+
          '</div>';
      } else if(a.fundamentals === '' && a.verdict === '') {
        researchHtml = '<div style="margin-top:8px;font-family:Share Tech Mono,monospace;font-size:9px;color:var(--muted);font-style:italic;">Fetching research intel...</div>';
      }

      card.innerHTML =
        '<div class="alert-top">'+
          '<div>'+
            '<div class="alert-symbol">'+a.symbol+dataBadge+'</div>'+
            '<div class="alert-market">'+(a.market||'')+' &bull; '+((a.type||'').toUpperCase())+'</div>'+
          '</div>'+
          '<div style="text-align:right">'+
            '<div class="alert-score '+(isStrong?'':'moderate')+'">'+Math.min(a.score,selectedInds.length)+'/'+selectedInds.length+'</div>'+
            '<div style="font-family:Share Tech Mono,monospace;font-size:9px;color:var(--muted);margin-top:2px;">'+(isStrong?'üî• STRONG':'‚ö° MODERATE')+'</div>'+
          '</div>'+
        '</div>'+
        '<div class="alert-signals">'+sigsHtml+'</div>'+
        rsiComboHtml+
        sentHtml+liqHtml+
        researchHtml+
        '<div class="alert-values">'+
          (a.price!==undefined?'<div class="alert-val">PRICE <span>$'+parseFloat(a.price).toPrecision(5)+'</span></div>':'')+
          (a.marketCap?'<div class="alert-val">MCAP <span>'+(a.marketCap>=1e9?(a.marketCap/1e9).toFixed(2)+'B':(a.marketCap/1e6).toFixed(0)+'M')+'</span></div>':'')+
          (a.vsEma200!==undefined&&a.vsEma200!==null?'<div class="alert-val" title="% above/below 200 EMA">EMA200 <span style="color:'+(a.vsEma200<0?'#00ff88':'#ff6b35')+';">'+(a.vsEma200>0?'+':'')+a.vsEma200+'%</span></div>':'')+
          (a.wt1!==undefined&&a.wt1!==null?'<div class="alert-val">WT1 <span style="color:'+(a.wt1<-53?'#00ff88':a.wt1>53?'#ff3366':'var(--accent)')+';">'+a.wt1+'</span></div>':'')+
          (a.wt2!==undefined&&a.wt2!==null?'<div class="alert-val">WT2 <span>'+a.wt2+'</span></div>':'')+
          (a.wtCrossed?'<div class="alert-val"><span style="color:'+(a.wtCrossType==='bullish'?'#00ff88':'#ff3366')+';font-weight:700;">'+(a.wtCrossType==='bullish'?'‚ñ≤ BULL CROSS':'‚ñº BEAR CROSS')+'</span></div>':'')+
          (a.rsi!==undefined?'<div class="alert-val">RSI <span>'+a.rsi+'</span></div>':'')+
          (a.rsiCombo&&a.rsiCombo.adx!==null?'<div class="alert-val">ADX <span style="color:var(--warn);">'+a.rsiCombo.adx+'</span></div>':'')+
          '<div class="alert-val">TF <span style="color:var(--accent);">'+selectedTF.label+'</span></div>'+
        '</div>';
      c.appendChild(card);
    });
  }

  function filterAlerts(type,btn) {
    document.querySelectorAll('.result-filter').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    let f=allAlerts;
    if(type==='strong') f=allAlerts.filter(a=>a.score>=3);
    else if(type==='moderate') f=allAlerts.filter(a=>a.score===2);
    else if(type==='crypto') f=allAlerts.filter(a=>a.type==='crypto');
    else if(type==='stocks') f=allAlerts.filter(a=>a.type==='stock');
    renderAlerts(f);
  }

  const BACKEND='https://apex-backend-k8kw.onrender.com';

  // ‚îÄ‚îÄ RSI Combo [by Marco] exact implementation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // RMA (Rolling Moving Average) = Pine's rma() ‚Äî same as Wilder's smoothing
  function calcRMASeries(src, period){
    const out=new Array(src.length).fill(null);
    // seed with SMA of first `period` values
    let sum=0, count=0;
    for(let i=0;i<src.length;i++){
      if(src[i]===null||src[i]===undefined) continue;
      sum+=src[i]; count++;
      if(count===period){
        out[i]=sum/period;
      } else if(count>period){
        const prev=out[i-1];
        out[i]=(prev*(period-1)+src[i])/period;
      }
    }
    return out;
  }

  // RSI using RMA (matches Pine's rsi() exactly)
  // up = rma(max(change(src),0), len)
  // down = rma(-min(change(src),0), len)
  // rsi = down==0 ? 100 : up==0 ? 0 : 100-(100/(1+up/down))
  function calcRSIComboSeries(closes, len=14){
    const n=closes.length;
    const changes=new Array(n).fill(null);
    for(let i=1;i<n;i++) changes[i]=closes[i]-closes[i-1];
    const gains=changes.map(v=>v===null?null:Math.max(v,0));
    const losses=changes.map(v=>v===null?null:Math.max(-v,0));
    const upSeries=calcRMASeries(gains,len);
    const downSeries=calcRMASeries(losses,len);
    const rsiSeries=upSeries.map((up,i)=>{
      if(up===null) return null;
      const down=downSeries[i];
      if(down===0) return 100;
      if(up===0) return 0;
      return 100-(100/(1+up/down));
    });
    return{rsiSeries,upSeries,downSeries};
  }

  // SMA series
  function calcSMASeries(src, period){
    const out=new Array(src.length).fill(null);
    for(let i=period-1;i<src.length;i++){
      if(src[i]===null) continue;
      let s=0,c=0;
      for(let j=i-period+1;j<=i;j++){if(src[j]!==null){s+=src[j];c++;}}
      if(c===period) out[i]=s/period;
    }
    return out;
  }

  // Momentum: mom(src, length) = src - src[length]
  function calcMomSeries(src, period){
    const out=new Array(src.length).fill(null);
    for(let i=period;i<src.length;i++){
      if(src[i]!==null&&src[i-period]!==null) out[i]=src[i]-src[i-period];
    }
    return out;
  }

  // Full RSI Combo ‚Äî returns all signals from Marco's script
  function calcRSICombo(closes){
    const n=closes.length;
    if(n<20) return null;

    // ‚îÄ‚îÄ Core RSI (RMA-based) ‚îÄ‚îÄ
    const {rsiSeries,upSeries,downSeries}=calcRSIComboSeries(closes,14);

    // ‚îÄ‚îÄ ADX of RSI ‚îÄ‚îÄ
    // sum = up + down
    // adx = 100 * rma(abs(up-down)/(sum==0?1:sum), 6)
    const adxInput=upSeries.map((up,i)=>{
      if(up===null||downSeries[i]===null) return null;
      const sum=up+downSeries[i];
      return Math.abs(up-downSeries[i])/(sum===0?1:sum);
    });
    const adxRma=calcRMASeries(adxInput,6);
    const adxSeries=adxRma.map(v=>v===null?null:100*v);

    // ‚îÄ‚îÄ Momentum of ADX ‚îÄ‚îÄ
    const amSeries=calcMomSeries(adxSeries,5);  // am = mom(adx,5)
    const rsiMom6=calcMomSeries(rsiSeries,6);    // mom(rsi,6)

    // ‚îÄ‚îÄ RSI Exhaustion signals ‚îÄ‚îÄ
    // mup:  rsi<42 AND am>0 AND mom(rsi,6)<0  ‚Üí oversold exhaustion (bullish)
    // mdown: rsi>58 AND am>0 AND mom(rsi,6)>0 ‚Üí overbought exhaustion (bearish)
    const last=n-1;
    const rsi=rsiSeries[last];
    const am=amSeries[last];
    const rsiM6=rsiMom6[last];
    const mup=rsi!==null&&am!==null&&rsiM6!==null && rsi<42&&am>0&&rsiM6<0;
    const mdown=rsi!==null&&am!==null&&rsiM6!==null && rsi>58&&am>0&&rsiM6>0;

    // ‚îÄ‚îÄ RSS ‚Äî Relative Spread Strength ‚îÄ‚îÄ
    // E1=ema(close,10), E2=ema(close,40)
    // Spread=E1-E2, RS=rsi(Spread,5), Smooth=sma(RS,3)
    const e1=calcEMASeries(closes,10);
    const e2=calcEMASeries(closes,40);
    const spread=e1.map((v,i)=>v!==null&&e2[i]!==null?v-e2[i]:null);
    const spreadCloses=spread.filter(v=>v!==null);
    const {rsiSeries:rsSeries}=calcRSIComboSeries(spreadCloses,5);
    const rsSmoothRaw=calcSMASeries(rsSeries,3);
    const smooth=rsSmoothRaw.filter(v=>v!==null);
    const smoothVal=smooth.length?smooth[smooth.length-1]:null;
    // Fill signals: smooth<18 ‚Üí oversold zone, smooth>82 ‚Üí overbought zone
    const rssOversold=smoothVal!==null&&smoothVal<18;
    const rssOverbought=smoothVal!==null&&smoothVal>82;

    // ‚îÄ‚îÄ Swing 350 ‚îÄ‚îÄ
    // rs=rsi(close,3), mrs=sma(rs,3)
    // BUY:  crossunder(sma(rs,3), 20) ‚Üí mrs just crossed below 20
    // SELL: crossover(sma(rs,3), 80)  ‚Üí mrs just crossed above 80
    const {rsiSeries:rs3Series}=calcRSIComboSeries(closes,3);
    const mrs=calcSMASeries(rs3Series,3);
    const mrsLast=mrs[last];
    const mrsPrev=mrs[last-1];
    const swing350Buy=mrsLast!==null&&mrsPrev!==null&&mrsPrev>=20&&mrsLast<20;
    const swing350Sell=mrsLast!==null&&mrsPrev!==null&&mrsPrev<=80&&mrsLast>80;

    return{
      rsi:rsi!==null?parseFloat(rsi.toFixed(1)):null,
      adx:adxSeries[last]!==null?parseFloat(adxSeries[last].toFixed(1)):null,
      am:am!==null?parseFloat(am.toFixed(2)):null,
      mup,    // RSI down-exhaustion bullish signal
      mdown,  // RSI up-exhaustion bearish signal
      smoothRSS:smoothVal!==null?parseFloat(smoothVal.toFixed(1)):null,
      rssOversold,
      rssOverbought,
      swing350Buy,
      swing350Sell,
      mrs:mrsLast!==null?parseFloat(mrsLast.toFixed(1)):null
    };
  }

  // Simple RSI (kept for backward compat with stock backend data)
  function calcRSI(closes,period){
    const {rsiSeries}=calcRSIComboSeries(closes,period);
    const valid=rsiSeries.filter(v=>v!==null);
    return valid.length?parseFloat(valid[valid.length-1].toFixed(1)):null;
  }

  // EMA returning full series (needed for WaveTrend chained EMAs)
  function calcEMASeries(src, period){
    if(!src||src.length<period) return [];
    const k=2/(period+1);
    const out=new Array(src.length).fill(null);
    // seed with SMA of first `period` values
    let seed=0; for(let i=0;i<period;i++) seed+=src[i];
    out[period-1]=seed/period;
    for(let i=period;i<src.length;i++) out[i]=src[i]*k+out[i-1]*(1-k);
    return out;
  }

  // SMA of last N values of a series
  function smaLast(series, period){
    const valid=series.filter(v=>v!==null);
    if(valid.length<period) return null;
    const last=valid.slice(-period);
    return last.reduce((a,b)=>a+b,0)/period;
  }

  function calcEMA(closes,period){
    const s=calcEMASeries(closes,period);
    const last=s.filter(v=>v!==null);
    return last.length?parseFloat(last[last.length-1].toFixed(4)):null;
  }

  function calcVolSpike(vols){
    if(!vols||vols.length<20) return null;
    const avg=vols.slice(-20,-1).reduce((a,b)=>a+b,0)/19;
    return avg>0?parseFloat((vols[vols.length-1]/avg).toFixed(2)):null;
  }

  // ‚îÄ‚îÄ WaveTrend [LazyBear] exact implementation ‚îÄ‚îÄ‚îÄ‚îÄ
  // n1=10 (Channel Length), n2=21 (Average Length)
  // ap  = hlc3
  // esa = ema(ap, n1)
  // d   = ema(abs(ap - esa), n1)
  // ci  = (ap - esa) / (0.015 * d)
  // tci = ema(ci, n2)
  // wt1 = tci
  // wt2 = sma(wt1, 4)
  function calcWaveTrend(highs, lows, closes, n1=10, n2=21){
    if(!highs||closes.length<n1+n2+4) return {wt1:null,wt2:null,crossed:false,crossType:null};
    // hlc3
    const ap=closes.map((c,i)=>(highs[i]+lows[i]+c)/3);
    // esa = EMA(ap, n1)
    const esa=calcEMASeries(ap, n1);
    // d = EMA(|ap - esa|, n1)
    const apMinusEsa=ap.map((v,i)=>esa[i]!==null?Math.abs(v-esa[i]):null);
    const validStart=apMinusEsa.findIndex(v=>v!==null);
    if(validStart===-1) return {wt1:null,wt2:null,crossed:false,crossType:null};
    const dInput=apMinusEsa.slice(validStart);
    const dSeries=calcEMASeries(dInput, n1);
    // rebuild d aligned to original length
    const d=new Array(validStart).fill(null).concat(dSeries);
    // ci = (ap - esa) / (0.015 * d)
    const ci=ap.map((v,i)=>{
      if(esa[i]===null||d[i]===null||d[i]===0) return null;
      return (v-esa[i])/(0.015*d[i]);
    });
    // tci = EMA(ci, n2)  ‚Äî strip leading nulls first
    const ciStart=ci.findIndex(v=>v!==null);
    if(ciStart===-1) return {wt1:null,wt2:null,crossed:false,crossType:null};
    const tciSeries=calcEMASeries(ci.slice(ciStart), n2);
    const wt1Series=new Array(ciStart).fill(null).concat(tciSeries);
    // wt2 = SMA(wt1, 4)
    const wt1Last=wt1Series.filter(v=>v!==null);
    const wt1=wt1Last.length?parseFloat(wt1Last[wt1Last.length-1].toFixed(2)):null;
    const wt2=wt1Last.length>=4?parseFloat(smaLast(wt1Last,4).toFixed(2)):null;
    // Detect cross ‚Äî check candle[n-2] vs candle[n-1] (confirmed, not just current)
    // Require wt1 to have actually crossed wt2 with separation > 0.5 to avoid noise
    let crossed=false, crossType=null;
    if(wt1Last.length>=6 && wt2!==null){
      // current bar values
      const curWt1=wt1Last[wt1Last.length-1];
      const curWt2=smaLast(wt1Last,4);
      // previous bar values (1 candle back)
      const prevWt1=wt1Last[wt1Last.length-2];
      const prevWt2=smaLast(wt1Last.slice(0,-1),4);
      // bar before that (2 candles back ‚Äî to confirm cross happened last bar)
      const prev2Wt1=wt1Last[wt1Last.length-3];
      const prev2Wt2=smaLast(wt1Last.slice(0,-2),4);
      if(prevWt1!==null&&prevWt2!==null&&prev2Wt1!==null&&prev2Wt2!==null){
        // Bullish cross: 2 bars ago wt1 was below wt2, last bar wt1 crossed above wt2
        // AND current bar wt1 still above wt2 (confirmation), AND both in oversold territory
        const bullishCross = prev2Wt1<prev2Wt2 && prevWt1>prevWt2 && curWt1>curWt2;
        // Bearish cross: 2 bars ago wt1 was above wt2, last bar crossed below
        const bearishCross = prev2Wt1>prev2Wt2 && prevWt1<prevWt2 && curWt1<curWt2;
        // Minimum separation to filter noise (WT scale is ~-100 to 100)
        const separation=Math.abs(curWt1-curWt2);
        if(separation>=0.5){
          if(bullishCross){ crossed=true; crossType='bullish'; }
          else if(bearishCross){ crossed=true; crossType='bearish'; }
        }
      }
    }
    return{wt1,wt2,crossed,crossType};
  }

  // Per-session caches so repeated scans skip known-failing sources
  const BINANCE_FUTURES_OK  = new Set();
  const BINANCE_SPOT_OK     = new Set();
  const NO_BINANCE          = new Set(); // confirmed absent from both Binance endpoints

  // Fetch with hard timeout ‚Äî no more hanging requests blocking batches
  async function fetchWithTimeout(url, ms=6000){
    const ctrl = new AbortController();
    const timer = setTimeout(()=>ctrl.abort(), ms);
    try{
      const res = await fetch(url, {signal:ctrl.signal});
      clearTimeout(timer);
      return res;
    }catch(e){ clearTimeout(timer); return null; }
  }

  // ‚îÄ‚îÄ Shared kline processor ‚Äî used by both crypto and stock fetchers ‚îÄ‚îÄ

  // ‚îÄ‚îÄ Bollinger Bands ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function calcBollingerBands(closes, period=20, mult=2){
    const n = closes.length;
    if(n < period) return null;
    const sma = closes.slice(-period).reduce((a,b)=>a+b,0)/period;
    const variance = closes.slice(-period).reduce((a,b)=>a+(b-sma)**2,0)/period;
    const stddev = Math.sqrt(variance);
    return {
      upper: parseFloat((sma+mult*stddev).toFixed(4)),
      mid:   parseFloat(sma.toFixed(4)),
      lower: parseFloat((sma-mult*stddev).toFixed(4)),
      price: closes[n-1],
      atLower: closes[n-1] <= (sma - mult*stddev),
      atUpper: closes[n-1] >= (sma + mult*stddev),
      pct:   parseFloat(((closes[n-1]-(sma-mult*stddev))/(4*mult*stddev)*100).toFixed(1))
    };
  }

  // ‚îÄ‚îÄ MACD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function calcMACD(closes, fast=12, slow=26, signal=9){
    if(closes.length < slow+signal) return null;
    const emaFast = calcEMASeries(closes, fast);
    const emaSlow = calcEMASeries(closes, slow);
    const macdLine = emaFast.map((v,i)=> v!==null&&emaSlow[i]!==null ? v-emaSlow[i] : null);
    const validMacd = macdLine.filter(v=>v!==null);
    if(validMacd.length < signal) return null;
    const signalSeries = calcEMASeries(validMacd, signal);
    const sigVal = signalSeries.filter(v=>v!==null);
    if(sigVal.length < 2) return null;
    const macdVal  = validMacd[validMacd.length-1];
    const sigLast  = sigVal[sigVal.length-1];
    const sigPrev  = sigVal[sigVal.length-2];
    const macdPrev = validMacd[validMacd.length-2];
    const histogram = macdVal - sigLast;
    // Bullish cross: macd crossed above signal last bar
    const bullishCross = macdPrev < sigPrev && macdVal > sigLast;
    const bearishCross = macdPrev > sigPrev && macdVal < sigLast;
    return {
      macd: parseFloat(macdVal.toFixed(4)),
      signal: parseFloat(sigLast.toFixed(4)),
      histogram: parseFloat(histogram.toFixed(4)),
      bullishCross, bearishCross
    };
  }

  // ‚îÄ‚îÄ Stochastic RSI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function calcStochRSI(closes, rsiLen=14, stochLen=14, kSmooth=3, dSmooth=3){
    try {
      if(closes.length < rsiLen+stochLen+kSmooth+dSmooth+5) return null;
      const {rsiSeries} = calcRSIComboSeries(closes, rsiLen);
      const validRsi = rsiSeries.filter(v=>v!==null);
      if(validRsi.length < stochLen) return null;
      // Stoch of RSI ‚Äî using simple SMA smoothing inline (safe, no index mismatch)
      const rawK = [];
      for(let i=stochLen-1; i<validRsi.length; i++){
        const win = validRsi.slice(i-stochLen+1, i+1);
        const lo = Math.min(...win), hi = Math.max(...win);
        rawK.push(hi===lo ? 50 : (validRsi[i]-lo)/(hi-lo)*100);
      }
      if(rawK.length < kSmooth+dSmooth+2) return null;
      // Smooth K
      const kArr = [];
      for(let i=kSmooth-1; i<rawK.length; i++){
        kArr.push(rawK.slice(i-kSmooth+1, i+1).reduce((a,b)=>a+b,0)/kSmooth);
      }
      // Smooth D
      const dArr = [];
      for(let i=dSmooth-1; i<kArr.length; i++){
        dArr.push(kArr.slice(i-dSmooth+1, i+1).reduce((a,b)=>a+b,0)/dSmooth);
      }
      if(kArr.length < 2 || dArr.length < 2) return null;
      const k = kArr[kArr.length-1], kPrev = kArr[kArr.length-2];
      const d = dArr[dArr.length-1], dPrev = dArr[dArr.length-2];
      return {
        k: parseFloat(k.toFixed(1)), d: parseFloat(d.toFixed(1)),
        oversold: k < 20 && d < 20, overbought: k > 80 && d > 80,
        bullishCross: kPrev < dPrev && k > d && k < 20,
        bearishCross: kPrev > dPrev && k < d && k > 80
      };
    } catch(e) { return null; }
  }

  // ‚îÄ‚îÄ ATR (Average True Range) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function calcATR(highs, lows, closes, period=14){
    if(closes.length < period+1) return null;
    const tr = closes.map((c,i)=>{
      if(i===0) return highs[i]-lows[i];
      return Math.max(highs[i]-lows[i], Math.abs(highs[i]-closes[i-1]), Math.abs(lows[i]-closes[i-1]));
    });
    // RMA of TR
    const atrSeries = calcRMASeries(tr, period);
    const valid = atrSeries.filter(v=>v!==null);
    if(valid.length < 2) return null;
    const atrNow  = valid[valid.length-1];
    const atrPrev = valid[valid.length-2];
    const atrPct  = parseFloat((atrNow/closes[closes.length-1]*100).toFixed(2));
    const expanding = atrNow > atrPrev * 1.1; // 10% expansion
    return { atr: parseFloat(atrNow.toFixed(4)), atrPct, expanding };
  }

  // ‚îÄ‚îÄ OBV (On Balance Volume) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function calcOBV(closes, volumes){
    if(closes.length < 20) return null;
    let obv = 0;
    const obvSeries = [0];
    for(let i=1; i<closes.length; i++){
      if(closes[i] > closes[i-1])      obv += volumes[i];
      else if(closes[i] < closes[i-1]) obv -= volumes[i];
      obvSeries.push(obv);
    }
    // OBV rising = last 5 bars trend up
    const recent = obvSeries.slice(-5);
    const rising = recent[recent.length-1] > recent[0];
    const obv5SmaStart = obvSeries.slice(-5).reduce((a,b)=>a+b,0)/5;
    const obv5SmaEnd   = obvSeries.slice(-3).reduce((a,b)=>a+b,0)/3;
    const strongRising = obv5SmaEnd > obv5SmaStart * 1.01;
    return { obv: parseFloat(obv.toFixed(0)), rising, strongRising };
  }

  // ‚îÄ‚îÄ Anchored VWAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Lookback is determined by user's anchor selection + asset type + timeframe
  function resolveVwapLookback(assetType){
    const anchor = selectedVwapAnchor || 'auto';
    const isWeekly = selectedTF.tf === '1w';
    const isDaily  = selectedTF.tf === '1d';
    const isCrypto = assetType === 'crypto';

    if(anchor === 'auto'){
      // Weekly: 52 bars ‚âà 1 year for both
      // Daily:  crypto 365 bars (24/7), stocks 252 bars (trading days)
      if(isWeekly) return 52;
      if(isDaily)  return isCrypto ? 365 : 252;
      return 52; // 4H default
    }
    if(anchor === 'ytd'){
      // Bars since Jan 1 of current year
      const now = new Date();
      const dayOfYear = Math.floor((now - new Date(now.getFullYear(),0,1)) / 86400000);
      if(isWeekly) return Math.max(1, Math.floor(dayOfYear / 7));
      if(isDaily)  return isCrypto ? dayOfYear : Math.floor(dayOfYear * 252/365);
      return Math.max(1, Math.floor(dayOfYear / 7));
    }
    if(anchor === 'crypto') return isWeekly ? 52 : 365;
    if(anchor === 'stock')  return isWeekly ? 52 : 252;
    return parseInt(anchor) || 52; // '52', '26', '13'
  }

  function calcVWAP(highs, lows, closes, volumes, assetType){
    const n = closes.length;
    if(n < 10) return null;
    const lookback = Math.min(n, resolveVwapLookback(assetType));
    const h = highs.slice(-lookback);
    const l = lows.slice(-lookback);
    const c = closes.slice(-lookback);
    const v = volumes.slice(-lookback);
    let cumPV = 0, cumV = 0;
    for(let i = 0; i < h.length; i++){
      const typical = (h[i] + l[i] + c[i]) / 3;
      const vol = v[i] || 0;
      cumPV += typical * vol;
      cumV  += vol;
    }
    if(cumV === 0) return null;
    const vwap = cumPV / cumV;
    const price = closes[n-1];
    const pctFromVwap = parseFloat(((price / vwap - 1) * 100).toFixed(2));
    const anchorBars = lookback;
    return {
      vwap: parseFloat(vwap.toFixed(4)),
      price, pctFromVwap, anchorBars,
      belowVwap: price < vwap,
      aboveVwap: price > vwap
    };
  }

  function processKlines(c, assetType){
    try {
    if(!c||c.length<20) return null;
    const highs  = c.map(x=>parseFloat(x[2]));
    const lows   = c.map(x=>parseFloat(x[3]));
    const closes = c.map(x=>parseFloat(x[4]));
    const volumes= c.map(x=>parseFloat(x[5]));
    const price  = closes[closes.length-1];
    const ema200 = calcEMA(closes,200);
    const wt     = calcWaveTrend(highs,lows,closes);
    const rsiCombo = calcRSICombo(closes);
    const recent52 = closes.slice(-52);
    const high52   = recent52.length ? Math.max(...recent52) : null;
    const vsHigh52 = high52 ? parseFloat(((price/high52-1)*100).toFixed(2)) : null;
    const bb       = calcBollingerBands(closes);
    const macd     = calcMACD(closes);
    const stochRsi = calcStochRSI(closes);
    const atr      = calcATR(highs, lows, closes);
    const obv      = calcOBV(closes, volumes);
    const vwap     = calcVWAP(highs, lows, closes, volumes, assetType);
    return {
      price, rsi: rsiCombo?rsiCombo.rsi:null, rsiCombo, ema200,
      ema50: calcEMA(closes,50), volSpike: calcVolSpike(volumes),
      vsEma200: ema200 ? parseFloat(((price/ema200-1)*100).toFixed(2)) : null,
      vsHigh52, bb, macd, stochRsi, atr, obv, vwap,
      wt1: wt.wt1, wt2: wt.wt2, wtCrossed: wt.crossed, wtCrossType: wt.crossType,
      type: assetType || 'crypto'
    };
    } catch(e) { console.warn('processKlines error:', e.message); return null; }
  }

  // ‚îÄ‚îÄ Fetch crypto: Binance Futures ‚Üí Spot ‚Üí Gate.io ‚Üí CoinGecko ‚îÄ‚îÄ
  async function fetchCryptoData(symbol){

    // 1Ô∏è‚É£ Binance Futures
    if(!NO_BINANCE.has(symbol)){
      const binanceInterval=selectedTF.interval==='1w'?'1W':selectedTF.interval==='4h'?'4h':'1d';
      const res=await fetchWithTimeout(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}USDT&interval=${binanceInterval}&limit=${selectedTF.limit}`, 6000);
      if(res&&res.ok){
        const c=await res.json().catch(()=>null);
        if(Array.isArray(c)&&c.length>0){
          const r=processKlines(c);
          if(r){ BINANCE_FUTURES_OK.add(symbol); return r; }
        }
      }

      // 2Ô∏è‚É£ Binance Spot
      const res2=await fetchWithTimeout(`https://api.binance.com/api/v3/klines?symbol=${symbol}USDT&interval=${binanceInterval}&limit=${selectedTF.limit}`, 6000);
      if(res2&&res2.ok){
        const c=await res2.json().catch(()=>null);
        if(Array.isArray(c)&&c.length>0){
          const r=processKlines(c);
          if(r){ BINANCE_SPOT_OK.add(symbol); return r; }
        }
      }
      NO_BINANCE.add(symbol); // mark as not on Binance ‚Äî skip both next scan
    }

    // 3Ô∏è‚É£ Gate.io ‚Äî only reaches here for non-Binance coins
    const gateInterval=selectedTF.tf==='1w'?'604800':selectedTF.tf==='1d'?'86400':'14400';
    const gRes=await fetchWithTimeout(`https://api.gateio.ws/api/v4/spot/candlesticks?currency_pair=${symbol}_USDT&interval=${gateInterval}&limit=${selectedTF.limit}`, 8000);
    if(gRes&&gRes.ok){
      const c=await gRes.json().catch(()=>null);
      if(Array.isArray(c)&&c.length>0){
        const converted=c.map(x=>[parseInt(x[0])*1000,parseFloat(x[5]),parseFloat(x[3]),parseFloat(x[4]),parseFloat(x[2]),parseFloat(x[1])]);
        const r=processKlines(converted);
        if(r) return r;
      }
    }

    // 4Ô∏è‚É£ CoinGecko ‚Äî absolute last resort
    try{
      const sRes=await fetchWithTimeout(`https://api.coingecko.com/api/v3/search?query=${encodeURIComponent(symbol)}`, 8000);
      if(!sRes) return null;
      const sd=await sRes.json();
      const match=sd.coins?.find(c=>c.symbol?.toUpperCase()===symbol.toUpperCase());
      if(!match) return null;
      const days=selectedTF.tf==='1w'?365:selectedTF.tf==='1d'?210:60;
      const oRes=await fetchWithTimeout(`https://api.coingecko.com/api/v3/coins/${match.id}/ohlc?vs_currency=usd&days=${days}`, 10000);
      if(!oRes) return null;
      const raw=await oRes.json();
      if(!raw||raw.length<35) return null;
      let klines=raw.map(c=>[c[0],c[1],c[2],c[3],c[4],0]);
      if(selectedTF.tf==='1w'){
        const wk=[];
        for(let i=0;i<klines.length;i+=7){
          const w=klines.slice(i,i+7);
          if(w.length<3) continue;
          wk.push([w[0][0],w[0][1],Math.max(...w.map(c=>c[2])),Math.min(...w.map(c=>c[3])),w[w.length-1][4],0]);
        }
        klines=wk;
      }
      return processKlines(klines);
    }catch(e){}
    return null;
  }

  // ‚îÄ‚îÄ Fetch liquidation data from Binance ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function fetchLiqData(symbol){
    try{
      const [oiRes,frRes,prRes]=await Promise.all([
        fetch('https://fapi.binance.com/fapi/v1/openInterest?symbol='+symbol+'USDT'),
        fetch('https://fapi.binance.com/fapi/v1/fundingRate?symbol='+symbol+'USDT&limit=1'),
        fetch('https://fapi.binance.com/fapi/v1/ticker/price?symbol='+symbol+'USDT')
      ]);
      if(!oiRes.ok||!frRes.ok||!prRes.ok) return null;
      const oi=await oiRes.json();
      const fr=await frRes.json();
      const pr=await prRes.json();
      const price=parseFloat(pr.price);
      const fundingRate=parseFloat(fr[0]?.fundingRate||0);
      const openInterest=parseFloat(oi.openInterest);
      const absFR=Math.abs(fundingRate);
      let lev=absFR>0.003?25:absFR>0.001?15:absFR>0.0005?10:absFR>0.0002?7:5;
      const longDist=fundingRate>=0?1/lev:1/(lev*0.6);
      const shortDist=fundingRate<0?1/lev:1/(lev*0.6);
      const longLiq=price*(1-longDist);
      const shortLiq=price*(1+shortDist);
      const distLong=parseFloat(((price-longLiq)/price*100).toFixed(2));
      const distShort=parseFloat(((shortLiq-price)/price*100).toFixed(2));
      const nearLong=distLong<=12;
      const nearShort=distShort<=12;
      const bias=fundingRate>0.0005?'LONGS_CROWDED':fundingRate<-0.0005?'SHORTS_CROWDED':'NEUTRAL';
      return{price,fundingRate,openInterest,longLiq:longLiq.toFixed(4),shortLiq:shortLiq.toFixed(4),
        distLong,distShort,nearLong,nearShort,bias,
        alert:nearLong||nearShort,alertType:nearLong?'NEAR_LONG_LIQ':'NEAR_SHORT_LIQ'};
    }catch(e){return null;}
  }

  // ‚îÄ‚îÄ Fetch stocks from Render backend ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function fetchStocksBatch(symbols){
    try{
      const yahooInterval=selectedTF.interval==='1w'?'1wk':selectedTF.interval==='4h'?'60m':'1d';
      const res=await fetch(BACKEND+'/stocks?symbols='+symbols.join(',')+'&interval='+yahooInterval,{signal:AbortSignal.timeout(30000)});
      if(!res.ok) return {};
      const raw=await res.json();
      const processed={};
      Object.keys(raw).forEach(sym=>{
        const item=raw[sym];
        if(item&&item.klines&&item.klines.length>=20){
          const d=processKlines(item.klines,'stock');
          if(d){
            d.marketCap=item.marketCap||null;
            processed[sym]=d;
          }
        }
      });
      return processed;
    }catch(e){console.log('Backend error:',e.message);return{};}
  }

  // ‚îÄ‚îÄ Fetch market cap from Yahoo Finance (free, no key) ‚îÄ‚îÄ
  async function fetchMarketCaps(symbols){
    const caps={};
    try{
      // Route through backend to avoid CORS ‚Äî fetch 1d kline which includes marketCap in meta
      const res=await fetch(BACKEND+'/stocks?symbols='+symbols.join(',')+'&interval=1d',
        {signal:AbortSignal.timeout(15000)});
      if(res.ok){
        const data=await res.json();
        Object.keys(data).forEach(sym=>{
          if(data[sym]&&data[sym].marketCap) caps[sym]=data[sym].marketCap;
        });
      }
    }catch(e){ console.log('fetchMarketCaps error:',e.message); }
    return caps;
  }
  async function wakeBackend(){
    const maxWait=75000; // 75 seconds max
    const interval=5000; // retry every 5 seconds
    const start=Date.now();
    let attempt=0;
    while(Date.now()-start<maxWait){
      attempt++;
      const elapsed=Math.round((Date.now()-start)/1000);
      document.getElementById('loadingStatus').textContent=
        attempt===1
          ? 'Waking stock data server (Render free tier sleeps ‚Äî please wait up to 60s)...'
          : `Still waking server... (${elapsed}s elapsed, retrying)`;
      try{
        const res=await fetch(BACKEND+'/health',{signal:AbortSignal.timeout(interval)});
        if(res.ok){
          document.getElementById('loadingStatus').textContent='Stock server is online! Fetching data...';
          return true;
        }
      }catch(e){}
      await new Promise(r=>setTimeout(r,1000));
    }
    return false;
  }

  // ‚îÄ‚îÄ Fetch Reddit sentiment ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function fetchRedditSentiment(symbols){
    const sentimentMap={};
    const topSymbols=symbols.slice(0,20);
    const bullish=['moon','pump','bullish','buy','long','breakout','surge','rally','up','gain','beat','upgrade','outperform','oversold','accumulate','undervalued','strong','ath','breakout'];
    const bearish=['dump','bearish','sell','short','crash','drop','down','fall','loss','rug','miss','downgrade','overbought','overvalued','weak','avoid','layoffs','scam','fraud'];
    await Promise.all(topSymbols.map(async sym=>{
      try{
        const url='https://www.reddit.com/search.json?q='+encodeURIComponent(sym)+'&sort=hot&limit=20&t=week';
        const res=await fetch(url,{headers:{'User-Agent':'ApexScanner/1.0'}});
        if(!res.ok) return;
        const data=await res.json();
        const posts=data?.data?.children||[];
        let b=0,bear=0,total=posts.length,ups=0;
        posts.forEach(p=>{
          const text=(p.data.title||'').toLowerCase();
          const u=p.data.ups||0;
          ups+=u;
          bullish.forEach(w=>{if(text.includes(w))b+=1+(u>100?1:0);});
          bearish.forEach(w=>{if(text.includes(w))bear+=1+(u>100?1:0);});
        });
        const score=b-bear;
        sentimentMap[sym]={
          label:score>1?'BULLISH':score<-1?'BEARISH':'NEUTRAL',
          emoji:score>1?'green':score<-1?'red':'yellow',
          posts:total,ups
        };
      }catch(e){}
    }));
    return sentimentMap;
  }



  // ‚îÄ‚îÄ Main scan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function runScan() {
    if(selectedMarkets.length===0){showToast('SELECT AT LEAST ONE MARKET');return;}
    if(selectedInds.length===0){showToast('SELECT AT LEAST ONE INDICATOR');return;}
    const has4hStocks = selectedTF.tf==='4h' && selectedMarkets.some(m=>['russell2000','sp500','nasdaq'].includes(m));
    if(has4hStocks) showToast('‚ö† 4H stocks use Yahoo 60m data ‚Äî limited history, fewer results than crypto');

    const wtT=document.getElementById('wtVal').textContent;
    const rsiT=document.getElementById('rsiVal').textContent;
    const volT=document.getElementById('volVal').textContent;
    const minT=document.getElementById('minT').value;
    const engineName=selectedEngine==='claude'?'CLAUDE':'GEMINI';

    document.getElementById('setupPanel').style.display='none';
    document.getElementById('loading').classList.add('visible');
    document.getElementById('resultsSection').classList.remove('visible');
    document.getElementById('engineLabel').textContent=`${engineName} IS ANALYZING MARKETS...`;
    allAlerts=[];

    try {
      // ‚îÄ‚îÄ Fetch live crypto lists from CoinGecko if needed ‚îÄ‚îÄ
      const needsCrypto = selectedMarkets.some(m => MARKET_TICKERS[m]?.type === 'crypto');
      if(needsCrypto){
        document.getElementById('loadingStatus').textContent = 'Fetching live top crypto list from CoinGecko...';
        const needs1000 = selectedMarkets.includes('crypto_top1000');
        const needs500  = selectedMarkets.includes('crypto_top500');
        const needsDefi = selectedMarkets.includes('defi');

        if(needs1000 || needs500){
          // Try CoinGecko silently ‚Äî tickers already initialized with built-in list so failure is OK
          const alreadyHaveLive = (needs500 && MARKET_TICKERS.crypto_top500._isLive) ||
                                  (needs1000 && MARKET_TICKERS.crypto_top1000._isLive);
          if(!alreadyHaveLive){
            try{
              const limit = needs1000 ? 1000 : 500;
              document.getElementById('loadingStatus').textContent = 'Upgrading crypto list from CoinGecko...';
              const liveSymbols = await fetchLiveCryptoList(limit);
              if(liveSymbols.length >= 50){
                if(needs500){ MARKET_TICKERS.crypto_top500.tickers = liveSymbols.slice(0,500); MARKET_TICKERS.crypto_top500._isLive=true; }
                if(needs1000){ MARKET_TICKERS.crypto_top1000.tickers = liveSymbols.slice(0,1000); MARKET_TICKERS.crypto_top1000._isLive=true; }
              }
              // If rate limited, silently keep using built-in list ‚Äî no toast, no crash
            }catch(e){ /* silently use built-in */ }
          }
          document.getElementById('loadingStatus').textContent = `Scanning ${MARKET_TICKERS[needs1000?'crypto_top1000':'crypto_top500'].tickers.length} crypto tickers...`;
        }

        if(needsDefi && !MARKET_TICKERS.defi.tickers){
          // Fetch DeFi category from CoinGecko
          try{
            const res = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&category=decentralized-finance-defi&order=market_cap_desc&per_page=50&page=1');
            if(res.ok){
              const data = await res.json();
              MARKET_TICKERS.defi.tickers = data.map(c=>c.symbol.toUpperCase()).filter(s=>!EXCLUDE_SYMBOLS.has(s));
            }
          }catch(e){}
          if(!MARKET_TICKERS.defi.tickers) MARKET_TICKERS.defi.tickers = ['UNI','AAVE','MKR','COMP','CRV','SNX','BAL','YFI','SUSHI','1INCH','CAKE','RUNE','LDO','CVX','GMX','DYDX','GNS','PERP','PENDLE','JOE'];
        }
      }

      // ‚îÄ‚îÄ Fetch live Russell 2000 constituents from backend (IWM ETF holdings) ‚îÄ‚îÄ
      if(selectedMarkets.includes('russell2000')){
        const alreadyHaveR2K = MARKET_TICKERS.russell2000.tickers && MARKET_TICKERS.russell2000.tickers.length > 100;
        if(alreadyHaveR2K){
          document.getElementById('loadingStatus').textContent = `Using cached Russell 2000 (${MARKET_TICKERS.russell2000.tickers.length} stocks)...`;
          await new Promise(r=>setTimeout(r,300));
        } else {
          document.getElementById('loadingStatus').textContent = 'Fetching live Russell 2000 constituents...';
          try {
            const res = await Promise.race([
              fetch(BACKEND + '/russell2000'),
              new Promise((_,reject) => setTimeout(() => reject(new Error('timeout')), 12000))
            ]);
            if(res.ok){
              const data = await res.json();
              if(data.tickers && data.tickers.length > 100){
                MARKET_TICKERS.russell2000.tickers = data.tickers;
                document.getElementById('loadingStatus').textContent = `Live Russell 2000: ${data.tickers.length} stocks loaded.`;
              }
            }
          } catch(e){
            console.log('Russell 2000 live fetch failed, using built-in list:', e.message);
          }
        }
      }

      // ‚îÄ‚îÄ Build ticker list ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let allTickers=[];
      selectedMarkets.forEach(m=>{
        if(MARKET_TICKERS[m]&&MARKET_TICKERS[m].tickers){
          MARKET_TICKERS[m].tickers.forEach(t=>{
            allTickers.push({symbol:t,market:MARKET_TICKERS[m].label,type:MARKET_TICKERS[m].type});
          });
        }
      });
      const seen=new Set();
      allTickers=allTickers.filter(t=>{if(seen.has(t.symbol))return false;seen.add(t.symbol);return true;});

      const marketsList=selectedMarkets.map(m=>MARKET_TICKERS[m]?.label).join(', ');
      // ‚îÄ‚îÄ Main data fetch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Use cached data if available for this timeframe ‚Äî skip re-fetch
      const cacheKey = getCacheKey(selectedTF.tf);
      // Load from cache but only keep assets in current allTickers selection
      const allTickerSymbols = new Set(allTickers.map(t=>t.symbol));
      const cachedRaw = DATA_CACHE[cacheKey] || {};
      const realData = {};
      Object.keys(cachedRaw).forEach(sym=>{ if(allTickerSymbols.has(sym)) realData[sym]=cachedRaw[sym]; });
      const hasCachedData = Object.keys(realData).length > 0;
      if(hasCachedData){
        document.getElementById('loadingStatus').textContent =
          `Using cached data for ${selectedTF.label} (${Object.keys(realData).length} assets). Re-scanning signals...`;
        await new Promise(r=>setTimeout(r,600));
      }
      const cryptoTickers=allTickers.filter(t=>t.type==='crypto');
      const stockTickers=allTickers.filter(t=>t.type==='stock');

      // Crypto ‚Äî fetch 50 at a time in parallel (Binance has no strict public rate limit)
      const BATCH = 50;
      const cryptoToFetch = hasCachedData ? cryptoTickers.filter(t=>!realData[t.symbol]) : cryptoTickers;
      if(hasCachedData && cryptoToFetch.length < cryptoTickers.length){
        debugLog(`Cache hit: ${cryptoTickers.length - cryptoToFetch.length} crypto from cache, fetching ${cryptoToFetch.length} new`);
      }
      for(let i=0;i<cryptoToFetch.length;i+=BATCH){
        const batch=cryptoToFetch.slice(i,i+BATCH);
        const pct=Math.round((i/cryptoToFetch.length)*100);
        document.getElementById('loadingStatus').textContent=`Scanning crypto ${i+1}‚Äì${Math.min(i+BATCH,cryptoToFetch.length)} of ${cryptoToFetch.length} (${pct}%)...`;
        await Promise.all(batch.map(async t=>{
          const d=await fetchCryptoData(t.symbol);
          if(d) realData[t.symbol]=d;
        }));
      }

      // Stocks from Render backend (with wake-up for free tier)
      const stocksToFetch = hasCachedData ? stockTickers.filter(t=>!realData[t.symbol]) : stockTickers;
      if(stocksToFetch.length>0){
        const isAwake = hasCachedData && stocksToFetch.length===0 ? true : await wakeBackend();
        if(isAwake){
          // Fetch 5 batches of 50 in parallel ‚Äî much faster than sequential 20s
          const STOCK_BATCH = 100;
          const CONCURRENCY  = 10;
          const stockSymbols = stocksToFetch.map(t=>t.symbol);
          const batches = [];
          for(let i=0;i<stockSymbols.length;i+=STOCK_BATCH){
            batches.push(stockSymbols.slice(i,i+STOCK_BATCH));
          }
          let done = 0;
          const scanStart = Date.now();
          for(let i=0;i<batches.length;i+=CONCURRENCY){
            const chunk = batches.slice(i, i+CONCURRENCY);
            const pct = Math.round((done*STOCK_BATCH/stockSymbols.length)*100);
            const elapsed = ((Date.now()-scanStart)/1000).toFixed(0);
            document.getElementById('loadingStatus').textContent=
              `Fetching stocks ${Math.min(done*STOCK_BATCH+1,stockSymbols.length)}‚Äì${Math.min((done+chunk.length)*STOCK_BATCH,stockSymbols.length)} of ${stockSymbols.length} (${pct}% ¬∑ ${elapsed}s)...`;
            const results = await Promise.all(chunk.map(b=>fetchStocksBatch(b)));
            results.forEach(r=>Object.assign(realData,r));
            done += chunk.length;
          }
          const stocksLoaded=stockTickers.filter(t=>realData[t.symbol]).length;
          const totalSecs=((Date.now()-scanStart)/1000).toFixed(0);
          document.getElementById('loadingStatus').textContent=`${stocksLoaded} of ${stockTickers.length} stocks loaded in ${totalSecs}s.`;
          // Save to cache for this timeframe
          DATA_CACHE[cacheKey] = Object.assign(DATA_CACHE[cacheKey]||{}, realData);
          await new Promise(r=>setTimeout(r,400));
        } else {
          document.getElementById('loadingStatus').textContent='‚ö† Stock server timed out. AI will estimate from training data ‚Äî results may not reflect current prices.';
          await new Promise(r=>setTimeout(r,3000));
        }
      }

      // Cache whatever crypto data we got so far
      if(cryptoToFetch && cryptoToFetch.length > 0){
        DATA_CACHE[cacheKey] = Object.assign(DATA_CACHE[cacheKey]||{}, realData);
      }
      const _cryptoDone = Object.keys(realData).filter(k=>realData[k]?.type==='crypto').length;
      const _stockDone  = Object.keys(realData).filter(k=>realData[k]?.type==='stock').length;
      debugLog(`Fetch complete: ${_cryptoDone} crypto, ${_stockDone} stocks with real data`);
      debugLog(`TF=${selectedTF.label} | inds=${selectedInds.join(',')} | minT=${document.getElementById('minT').value}`);
      // Market cap fetch & filter for stocks
      // Build marketCapData from realData (backend returns marketCap per stock)
      const marketCapData={};
      stockTickers.forEach(t=>{
        const d=realData[t.symbol];
        if(d&&d.marketCap) marketCapData[t.symbol]=d.marketCap;
      });

      // If mcap filter is active, fetch caps for any stocks missing cap data
      if(selectedMcap>0 && stockTickers.length>0){
        const missingCap = stockTickers.filter(t=>realData[t.symbol]&&!marketCapData[t.symbol]);
        if(missingCap.length>0){
          document.getElementById('loadingStatus').textContent='Fetching market caps for '+missingCap.length+' stocks missing cap data...';
          for(let i=0;i<missingCap.length;i+=20){
            const batch=missingCap.slice(i,i+20).map(t=>t.symbol);
            const caps=await fetchMarketCaps(batch);
            Object.assign(marketCapData,caps);
          }
        }
        const passing=stockTickers.filter(t=>{
          if(!realData[t.symbol]) return false;
          const cap=marketCapData[t.symbol];
          if(!cap) return true; // no cap data ‚Äî include (Russell 2000 are small cap by definition)
          return cap<selectedMcap*1e9;
        }).length;
        document.getElementById('loadingStatus').textContent=passing+' of '+stockTickers.filter(t=>realData[t.symbol]).length+' stocks pass <$'+selectedMcap+'B market cap filter.';
        await new Promise(r=>setTimeout(r,500));
      }

      // Liquidation data for crypto
      document.getElementById('loadingStatus').textContent='Fetching liquidation zone data...';
      const liqData={};
      const cryptoWithData=cryptoTickers.filter(t=>realData[t.symbol]).slice(0,100);
      for(let i=0;i<cryptoWithData.length;i+=10){
        const batch=cryptoWithData.slice(i,i+10);
        await Promise.all(batch.map(async t=>{
          const d=await fetchLiqData(t.symbol);
          if(d) liqData[t.symbol]=d;
        }));
        await new Promise(r=>setTimeout(r,200));
      }

      // Pre-filter with real data
      const stocksWithRealData = Object.keys(realData).filter(k=>realData[k].type==='stock');
      const cryptoWithRealData = Object.keys(realData).filter(k=>realData[k].type==='crypto');
      debugLog(`Real data loaded: ${stocksWithRealData.length} stocks, ${cryptoWithRealData.length} crypto`);
      if(stocksWithRealData.length===0 && stockTickers.length>0) debugLog('‚ö† No stocks got real data ‚Äî backend may be down or returning empty');
      if(cryptoWithRealData.length===0 && cryptoTickers.length>0) debugLog('‚ö† No crypto got real data ‚Äî Binance/Gate.io may be blocked');
      if(stocksWithRealData.length>0){
        const sample = realData[stocksWithRealData[0]];
        console.log(`[APEX] Sample stock (${stocksWithRealData[0]}):`, JSON.stringify({
          wt1:sample.wt1, wt2:sample.wt2, rsi:sample.rsi, ema200:sample.ema200,
          vsEma200:sample.vsEma200, volSpike:sample.volSpike, wtCrossed:sample.wtCrossed
        }));
      }
      debugLog(`Selected indicators:`, selectedInds);
      debugLog(`Min match threshold:`, minT);

      const qualified=[];
      allTickers.forEach(t=>{
        const d=realData[t.symbol];
        if(!d) return;
        // Market cap filter for stocks
        if(selectedMcap>0 && t.type==='stock'){
          const cap=marketCapData[t.symbol];
          // If no cap data available, include the stock (Russell 2000 are small cap by definition)
          // Only hard-exclude if we actually know the cap exceeds the limit
          if(cap && cap>=selectedMcap*1e9) return;
        }
        const sigs=[];
        // WaveTrend [LazyBear]
        if(d.wt1!==null&&d.wt2!==null){
          if(d.wt1<-60) sigs.push('WaveTrend:WT Deeply Oversold ('+d.wt1+')');
          else if(d.wt1<parseFloat(wtT)) sigs.push('WaveTrend:WT Oversold ('+d.wt1+')');
          if(d.wtCrossed&&d.wtCrossType==='bullish'&&d.wt1<0) sigs.push('WaveTrend:WT Bullish Cross ('+d.wt1+')');
          if(d.wt1>60) sigs.push('WaveTrend:WT Deeply Overbought ('+d.wt1+')');
          else if(d.wt1>53) sigs.push('WaveTrend:WT Overbought ('+d.wt1+')');
          if(d.wtCrossed&&d.wtCrossType==='bearish'&&d.wt1>0) sigs.push('WaveTrend:WT Bearish Cross ('+d.wt1+')');
        }
        // RSI Combo [Marco] ‚Äî fires on green dot (mup) or red dot (mdown)
        if(d.rsiCombo){
          const rc=d.rsiCombo;
          if(rc.mup)   sigs.push('RSI Combo:üü¢ RSI Green Dot (RSI:'+rc.rsi+' ADXm:'+rc.am+')');
          if(rc.mdown) sigs.push('RSI Combo:üî¥ RSI Red Dot (RSI:'+rc.rsi+' ADXm:'+rc.am+')');
        }
        // Plain RSI oversold fallback for stocks without rsiCombo
        if(!d.rsiCombo&&d.rsi!==null&&d.rsi<parseFloat(rsiT)) sigs.push('RSI Combo:RSI Oversold ('+d.rsi+')');
        if(d.volSpike!==null&&d.volSpike>=parseFloat(volT)&&selectedTF.tf!=='1w') sigs.push('Volume Spike:Volume Spike '+d.volSpike+'x');
        if(d.vsEma200!==null&&Math.abs(d.vsEma200)<=5) sigs.push('200 EMA proximity:Near 200 EMA ('+d.vsEma200+'%)');
        if(d.vsEma200!==null&&d.vsEma200>20) sigs.push('200 EMA proximity:Extended above 200 EMA ('+d.vsEma200+'%)');
        if(d.vsHigh52!==null&&d.vsHigh52>-5) sigs.push('200 EMA proximity:Near 52W High ('+d.vsHigh52+'%)');
        // Bollinger Bands
        if(d.bb){
          if(d.bb.atLower) sigs.push('Bollinger Band Lower Touch:BB Lower Touch (price='+d.bb.price.toPrecision(5)+' lower='+d.bb.lower.toPrecision(5)+')');
          if(d.bb.atUpper) sigs.push('Bollinger Band Lower Touch:BB Upper Touch (price='+d.bb.price.toPrecision(5)+' upper='+d.bb.upper.toPrecision(5)+')');
        }
        // MACD Crossover
        if(d.macd){
          if(d.macd.bullishCross) sigs.push('MACD Crossover:MACD Bullish Cross (hist='+d.macd.histogram.toFixed(4)+')');
          if(d.macd.bearishCross) sigs.push('MACD Crossover:MACD Bearish Cross (hist='+d.macd.histogram.toFixed(4)+')');
        }
        // Stochastic RSI
        if(d.stochRsi){
          if(d.stochRsi.bullishCross) sigs.push('Stochastic RSI:StochRSI Bullish Cross (K='+d.stochRsi.k+' D='+d.stochRsi.d+')');
          if(d.stochRsi.bearishCross) sigs.push('Stochastic RSI:StochRSI Bearish Cross (K='+d.stochRsi.k+' D='+d.stochRsi.d+')');
          if(d.stochRsi.oversold)     sigs.push('Stochastic RSI:StochRSI Oversold (K='+d.stochRsi.k+')');
        }
        // ATR Expansion
        if(d.atr&&d.atr.expanding) sigs.push('ATR Expansion:ATR Expanding ('+d.atr.atrPct+'% of price)');
        // OBV Rising
        if(d.obv&&d.obv.strongRising) sigs.push('OBV Rising:OBV Accumulation Rising');
        // VWAP
        if(d.vwap){
          const anchorLabel = d.vwap.anchorBars+'bar anchor';
          if(d.vwap.belowVwap) sigs.push('VWAP:Below VWAP '+d.vwap.pctFromVwap+'% ('+anchorLabel+' VWAP=$'+d.vwap.vwap.toPrecision(5)+')');
          if(d.vwap.aboveVwap&&d.vwap.pctFromVwap>10) sigs.push('VWAP:Extended +'+d.vwap.pctFromVwap+'% above VWAP ('+anchorLabel+')');
        }
        // Liq Zone (crypto only)
        const liq=liqData[t.symbol];
        if(liq&&liq.alert){
          const dist=liq.alertType==='NEAR_LONG_LIQ'?liq.distLong:liq.distShort;
          sigs.push('Liq Zone:'+(liq.alertType==='NEAR_LONG_LIQ'?'üî¥ Long Liq Zone':'üü¢ Short Liq Zone')+' '+dist+'% away');
        }
        // Count how many selected indicators are triggered
        const triggeredInds=new Set(sigs.map(s=>s.split(':')[0]));
        const matchCount=[...triggeredInds].filter(k=>selectedInds.includes(k)).length;
        if(matchCount>=parseInt(minT)) qualified.push({...t,sigs,d,liq:liq||null,marketCap:marketCapData[t.symbol]||null});
      });

      // Log qualification results for debugging
      debugLog(`Qualified: ${qualified.length} assets`);
      if(qualified.length===0 && allTickers.length>0){
        // Sample 3 stocks to show why they failed
        let checked=0;
        allTickers.forEach(t=>{
          if(checked>=3) return;
          const d=realData[t.symbol];
          if(!d) return;
          const sigs=[];
          if(d.wt1!==null) sigs.push(`WT1=${d.wt1}`);
          if(d.rsi!==null) sigs.push(`RSI=${d.rsi}`);
          if(d.vsEma200!==null) sigs.push(`vsEMA=${d.vsEma200}%`);
          if(d.volSpike!==null) sigs.push(`volSpike=${d.volSpike}x`);
          console.log(`[APEX] ${t.symbol} data:`, sigs.join(', '), '| wtCrossed:', d.wtCrossed, d.wtCrossType);
          checked++;
        });
        debugLog(`WaveTrend threshold: <${wtT} or >53`);
        debugLog(`RSI threshold: <${rsiT}`);
        debugLog(`Vol spike threshold: >${volT}x`);
        // Log sample WT1/RSI values to diagnose threshold mismatches
        const sampleAssets = allTickers.filter(t=>realData[t.symbol]).slice(0,5);
        sampleAssets.forEach(t=>{
          const sd=realData[t.symbol];
          debugLog(`${t.symbol}: wt1=${sd.wt1}, rsi=${sd.rsi}, vol=${sd.volSpike}, bb=${sd.bb?.atLower}`);
        });
      }

      // Sort by number of triggered selected indicators (descending), cap at 20
      qualified.sort((a,b)=>{
        const aScore=[...new Set(a.sigs.map(s=>s.split(':')[0]))].filter(k=>selectedInds.includes(k)).length;
        const bScore=[...new Set(b.sigs.map(s=>s.split(':')[0]))].filter(k=>selectedInds.includes(k)).length;
        return bScore-aScore;
      });
      const topQualified=qualified.slice(0,20);

      // Reddit sentiment for qualified assets
      document.getElementById('loadingStatus').textContent='Fetching Reddit sentiment...';
      const qualSymbols=topQualified.map(q=>q.symbol);
      const sentimentMap=await fetchRedditSentiment(qualSymbols);

      const realCount=Object.keys(realData).length;
      const stockReal=Object.values(realData).filter(d=>d.type==='stock').length;
      document.getElementById('loadingStatus').textContent=realCount+' assets scanned ('+stockReal+' stocks real data) on '+selectedTF.label+'. '+topQualified.length+' qualify (top '+Math.min(topQualified.length,20)+' by score). Formatting with AI...';
      await new Promise(r=>setTimeout(r,300));

      // ‚îÄ‚îÄ All numbers come from real data ‚Äî AI never touches indicators ‚îÄ‚îÄ
      if(topQualified.length===0){
        document.getElementById('loading').classList.remove('visible');
        document.getElementById('setupPanel').style.display='block';
        const realCount2 = Object.keys(realData).length;
        const stockCount2 = Object.keys(realData).filter(k=>realData[k].type==='stock').length;
        const cryptoCount2 = Object.keys(realData).filter(k=>realData[k].type==='crypto').length;
        showError(`No assets qualified on ${selectedTF.label}. Got real data for ${realCount2} assets (${stockCount2} stocks, ${cryptoCount2} crypto). ` +
          `Try: lower MIN CONDITIONS to 1, select fewer indicators, or widen WT/RSI thresholds.`);
        return;
      }

      // Build results 100% from real calculated values ‚Äî zero AI involvement in numbers
      let parsed = topQualified.map(q => {
        const rd = q.d;
        const signals = q.sigs.map(s => s.includes(':') ? s.split(':').slice(1).join(':') : s);
        const triggeredInds = new Set(q.sigs.map(s => s.split(':')[0]));
        const score = [...triggeredInds].filter(k => selectedInds.includes(k)).length;
        const obj = {
          symbol: q.symbol, market: q.market, type: q.type,
          score, signals, timeframe: selectedTF.label, dataSource: 'live',
          price: rd.price, wt1: rd.wt1, wt2: rd.wt2,
          wtCrossed: rd.wtCrossed, wtCrossType: rd.wtCrossType,
          rsi: rd.rsi, rsiCombo: rd.rsiCombo,
          vsEma200: rd.vsEma200, volSpike: rd.volSpike,
          marketCap: q.marketCap || null,
          fundamentals: '', disruptive: '', news: '', verdict: ''
        };
        if(sentimentMap && sentimentMap[q.symbol]){
          const s = sentimentMap[q.symbol];
          obj.sentiment = s.label+' ('+s.posts+' posts, '+s.ups+' upvotes)';
          obj.sentimentEmoji = s.emoji;
        }
        const liq = liqData && liqData[q.symbol];
        if(liq){
          obj.distLong=liq.distLong; obj.distShort=liq.distShort;
          obj.fundingBias=liq.bias; obj.nearLiq=liq.alert; obj.nearLiqType=liq.alertType;
          if(liq.alert){
            const dist=liq.alertType==='NEAR_LONG_LIQ'?liq.distLong:liq.distShort;
            obj.liqAlert=(liq.alertType==='NEAR_LONG_LIQ'?'üî¥ Long Liq Zone':'üü¢ Short Liq Zone')+' '+dist+'% away | Funding: '+liq.bias;
          }
        }
        return obj;
      });

      allAlerts = parsed;
      sendTelegram(parsed, sentimentMap, liqData);

      // Show results immediately ‚Äî no waiting for AI
      document.getElementById('loading').classList.remove('visible');
      document.getElementById('resultsSection').classList.add('visible');
      const strong = allAlerts.filter(a=>a.score>=3).length;
      document.getElementById('statTotal').textContent    = allAlerts.length;
      document.getElementById('statStrong').textContent   = strong;
      document.getElementById('statMod').textContent      = allAlerts.length - strong;
      document.getElementById('statEngine').textContent   = engineName;
      allAlerts.sort((a,b)=>b.score-a.score);
      renderAlerts(allAlerts);

      // ‚îÄ‚îÄ Market summary (AI uses only real numbers we provide) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      document.getElementById('loading').classList.add('visible');
      document.getElementById('loadingStatus').textContent = 'Generating market summary...';
      const topAssets = parsed.slice(0,5).map(a=>
        `${a.symbol}: RSI=${a.rsi}, WT1=${a.wt1}, vsEMA200=${a.vsEma200!==undefined?a.vsEma200+'%':'N/A'}, signals=[${(a.signals||[]).join(', ')}]`
      ).join('\n');
      const summaryPrompt = `You are a trading analyst. Based on REAL scanned data from ${marketsList} on ${new Date().toDateString()}, write a 3-sentence market summary:\n\nTOP QUALIFYING ASSETS (real data):\n${topAssets||'No assets qualified'}\n\n1. Overall market sentiment based on the data\n2. Which assets look most interesting and why\n3. Key risk to watch\n\nBe direct. Reference actual assets and numbers. No disclaimers about real-time data ‚Äî you have it above.`;
      try {
        const summary = await callAI(summaryPrompt);
        const renderMarkdown = text => text
          .replace(/^#{1,3}\s+(.+)$/gm,'<strong style="font-family:Orbitron,monospace;font-size:11px;color:var(--accent);letter-spacing:1px;">$1</strong>')
          .replace(/\*\*(.+?)\*\*/g,'<strong style="color:var(--strong);">$1</strong>')
          .replace(/\*(.+?)\*/g,'<em>$1</em>')
          .replace(/\n\n/g,'<br><br>').replace(/\n/g,'<br>');
        document.getElementById('aiSummaryText').innerHTML = renderMarkdown(summary);
        document.getElementById('aiSummary').classList.add('visible');
      } catch(e){ console.warn('Summary failed:',e.message); }

      // ‚îÄ‚îÄ AI Fundamental Enrichment ‚Äî knowledge only, no numbers ‚îÄ‚îÄ‚îÄ‚îÄ
      document.getElementById('loadingStatus').textContent = 'Fetching fundamentals & news intel...';

      // Company name map so AI can identify obscure tickers (especially Russell 2000 small caps)
      const STOCK_NAMES = {
        // ‚îÄ‚îÄ S&P 500 / Nasdaq 100 ‚Äî Large Caps ‚îÄ‚îÄ
        'AAPL':'Apple ‚Äî iPhone Mac iPad Services ecosystem; revenue ~$400B; highest market cap company; services segment growing',
        'MSFT':'Microsoft ‚Äî Azure cloud Office365 Teams GitHub Copilot AI; revenue ~$230B; dominant enterprise software',
        'AMZN':'Amazon ‚Äî AWS cloud ecommerce Prime advertising; revenue ~$600B; AWS 17%+ growth',
        'NVDA':'Nvidia ‚Äî AI GPU data center H100/H200/Blackwell; revenue ~$130B FY2025; dominant AI infrastructure',
        'GOOGL':'Alphabet ‚Äî Google Search YouTube Google Cloud Gemini AI Waymo; revenue ~$340B',
        'GOOG':'Alphabet Class C ‚Äî same as GOOGL; Google Search YouTube Cloud AI',
        'META':'Meta Platforms ‚Äî Facebook Instagram WhatsApp Threads; revenue ~$165B; AI infrastructure investment',
        'TSLA':'Tesla ‚Äî EVs energy storage solar Optimus robot FSD; revenue ~$100B; margin under pressure',
        'BRK-B':'Berkshire Hathaway ‚Äî Buffett conglomerate insurance GEICO BNSF energy equity portfolio',
        'LLY':'Eli Lilly ‚Äî Mounjaro Zepbound GLP-1 weight loss diabetes drugs; revenue ~$45B growing 50%+ YoY',
        'JPM':'JPMorgan Chase ‚Äî largest US bank investment banking consumer; revenue ~$160B',
        'V':'Visa ‚Äî global payments network 90%+ margins; revenue ~$36B; network effect moat',
        'XOM':'ExxonMobil ‚Äî integrated oil gas refining chemicals; revenue ~$400B; Pioneer acquisition',
        'MA':'Mastercard ‚Äî global payments network; revenue ~$27B; international growth',
        'PG':'Procter & Gamble ‚Äî consumer staples Tide Pampers Gillette; revenue ~$84B; pricing power',
        'JNJ':'Johnson & Johnson ‚Äî pharma MedTech; revenue ~$88B; Kenvue consumer spinoff 2023',
        'HD':'Home Depot ‚Äî home improvement retail; revenue ~$153B; Pro contractor focus',
        'AVGO':'Broadcom ‚Äî networking AI chips custom accelerators VMware software; revenue ~$55B',
        'MRK':'Merck ‚Äî Keytruda cancer immunotherapy Gardasil vaccine; revenue ~$60B',
        'CVX':'Chevron ‚Äî integrated oil gas; revenue ~$200B; Hess acquisition pending',
        'PEP':'PepsiCo ‚Äî beverages snacks Frito-Lay Quaker; revenue ~$91B',
        'ABBV':'AbbVie ‚Äî Humira Skyrizi Rinvoq immunology oncology; revenue ~$56B',
        'COST':'Costco ‚Äî warehouse membership retail; revenue ~$240B; extremely loyal members',
        'KO':'Coca-Cola ‚Äî global beverages; revenue ~$46B; dividend aristocrat',
        'WMT':'Walmart ‚Äî retail ecommerce Flipkart Sam Club; revenue ~$650B; fastest growing segment advertising',
        'ADBE':'Adobe ‚Äî Creative Cloud Firefly AI Document Cloud; revenue ~$22B',
        'CRM':'Salesforce ‚Äî cloud CRM Agentforce AI Data Cloud; revenue ~$36B',
        'BAC':'Bank of America ‚Äî US retail commercial investment bank; assets ~$3.3T',
        'MCD':'McDonald\'s ‚Äî global fast food franchise; revenue ~$26B; digital ordering growth',
        'PFE':'Pfizer ‚Äî COVID vaccine revenue declining; oncology pipeline Paxlovid; revenue ~$58B',
        'TMO':'Thermo Fisher Scientific ‚Äî life science instruments reagents services; revenue ~$42B',
        'CSCO':'Cisco ‚Äî networking hardware software security; revenue ~$54B; AI networking upgrade cycle',
        'ABT':'Abbott Labs ‚Äî medical devices diagnostics nutrition; revenue ~$40B',
        'ACN':'Accenture ‚Äî IT consulting digital transformation; revenue ~$65B',
        'NKE':'Nike ‚Äî athletic footwear apparel; revenue ~$51B; DTC focus; turnaround underway',
        'DHR':'Danaher ‚Äî life science tools water quality; revenue ~$24B post Veralto spinoff',
        'LIN':'Linde ‚Äî industrial gases; revenue ~$33B; clean energy hydrogen',
        'CMCSA':'Comcast ‚Äî broadband cable NBCUniversal Peacock; revenue ~$122B',
        'TXN':'Texas Instruments ‚Äî analog semiconductors; revenue ~$17B; automotive industrial',
        'VZ':'Verizon ‚Äî wireless broadband; revenue ~$134B; 5G build out',
        'PM':'Philip Morris ‚Äî IQOS heated tobacco ZYN nicotine pouches international; revenue ~$35B',
        'NEE':'NextEra Energy ‚Äî renewable wind solar utilities; revenue ~$24B; largest wind operator',
        'RTX':'RTX (Raytheon) ‚Äî defense missiles Pratt Whitney engines Collins aerospace; revenue ~$69B',
        'HON':'Honeywell ‚Äî industrial automation aerospace building tech; revenue ~$37B; breakup planned',
        'AMGN':'Amgen ‚Äî biologics Repatha Enbrel MariTide obesity; revenue ~$33B',
        'IBM':'IBM ‚Äî hybrid cloud AI consulting Red Hat; revenue ~$62B; HashiCorp acquisition',
        'UNP':'Union Pacific ‚Äî railroad freight western US; revenue ~$24B',
        'INTC':'Intel ‚Äî x86 CPUs foundry services; revenue ~$54B declining; turnaround under Lip-Bu Tan',
        'QCOM':'Qualcomm ‚Äî mobile chips Snapdragon automotive PC diversification; revenue ~$39B',
        'INTU':'Intuit ‚Äî TurboTax QuickBooks Credit Karma; revenue ~$17B',
        'SBUX':'Starbucks ‚Äî global coffee chain; revenue ~$36B; Brian Niccol turnaround',
        'GE':'GE Aerospace ‚Äî jet engines CFM LEAP; revenue ~$32B post GE Vernova spinoff',
        'LOW':'Lowe\'s ‚Äî home improvement retail; revenue ~$86B; Pro segment focus',
        'AMD':'AMD ‚Äî CPUs GPUs MI300X AI accelerator; revenue ~$25B competing with Nvidia',
        'CAT':'Caterpillar ‚Äî construction mining equipment; revenue ~$67B; infrastructure spending',
        'DE':'Deere & Company ‚Äî agricultural equipment precision ag technology; revenue ~$55B',
        'SPGI':'S&P Global ‚Äî credit ratings data analytics Market Intelligence; revenue ~$14B',
        'MS':'Morgan Stanley ‚Äî investment banking wealth management; revenue ~$54B',
        'GS':'Goldman Sachs ‚Äî investment banking trading asset management; revenue ~$47B',
        'BLK':'BlackRock ‚Äî world largest asset manager $10T+ AUM; ETF leader',
        'NFLX':'Netflix ‚Äî streaming 300M+ subscribers ad tier gaming; revenue ~$38B',
        'PYPL':'PayPal ‚Äî digital payments Venmo Braintree; revenue ~$31B; margin improvement focus',
        'ADP':'ADP ‚Äî payroll HR services; revenue ~$18B; steady compounder',
        'MELI':'MercadoLibre ‚Äî Latin America ecommerce fintech; revenue ~$20B growing 35%+ YoY',
        'ASML':'ASML ‚Äî EUV lithography machines critical semiconductor supply chain; revenue ~$28B',
        'ISRG':'Intuitive Surgical ‚Äî Da Vinci robotic surgery; revenue ~$8B growing 15%+ YoY',
        'KLAC':'KLA Corp ‚Äî semiconductor process control equipment; revenue ~$10B',
        'LRCX':'Lam Research ‚Äî semiconductor etch deposition equipment; revenue ~$17B',
        'SNPS':'Synopsys ‚Äî EDA chip design software AI; revenue ~$6.1B; ANSYS acquisition',
        'CDNS':'Cadence Design ‚Äî EDA software verification; revenue ~$4.6B',
        'MRVL':'Marvell Technology ‚Äî custom AI chips for cloud providers networking; revenue ~$6B',
        'PANW':'Palo Alto Networks ‚Äî cybersecurity SASE cloud; revenue ~$8.2B',
        'CRWD':'CrowdStrike ‚Äî endpoint security cloud Falcon platform; revenue ~$3.8B; July 2024 outage',
        'AMAT':'Applied Materials ‚Äî semiconductor equipment leader; revenue ~$27B',
        'MDLZ':'Mondelez ‚Äî snacks Oreo Cadbury; revenue ~$36B international',
        'GILD':'Gilead Sciences ‚Äî HIV antivirals Veklury oncology; revenue ~$27B',
        'REGN':'Regeneron ‚Äî Dupixent Eylea VEGF Trap; revenue ~$14B; Dupixent dominates',
        'VRTX':'Vertex Pharmaceuticals ‚Äî cystic fibrosis drugs Trikafta; revenue ~$10B near monopoly',
        'FTNT':'Fortinet ‚Äî network security firewalls; revenue ~$5.6B; OT security growth',
        'FAST':'Fastenal ‚Äî industrial distribution fasteners vending; revenue ~$7B',
        'CPRT':'Copart ‚Äî vehicle auction salvage online; revenue ~$4B; high moat',
        'MNST':'Monster Beverage ‚Äî energy drinks; revenue ~$7.8B; Coca-Cola distribution',
        'DDOG':'Datadog ‚Äî cloud observability monitoring; revenue ~$2.7B; AI adoption tailwind',
        'ROST':'Ross Stores ‚Äî off-price retail; revenue ~$21B',
        'PAYX':'Paychex ‚Äî payroll HR for small business; revenue ~$5.3B',
        'ODFL':'Old Dominion Freight ‚Äî premium LTL trucking; revenue ~$6B; best-in-class margins',
        'PDD':'PDD Holdings ‚Äî Temu Pinduoduo ecommerce; revenue ~$35B',
        'KDP':'Keurig Dr Pepper ‚Äî beverages coffee pods; revenue ~$15B',
        'ORLY':'O\'Reilly Auto ‚Äî auto parts retail; revenue ~$16.7B',
        'PCAR':'PACCAR ‚Äî Kenworth Peterbilt trucks; revenue ~$35B',
        'CTAS':'Cintas ‚Äî uniform services workplace safety; revenue ~$9.8B',
        // ‚îÄ‚îÄ Russell 2000 Technology ‚îÄ‚îÄ
        'ALKT':'Alkami Technology ‚Äî cloud digital banking SaaS for credit unions community banks; revenue ~$330M growing 25%+ YoY; sticky enterprise contracts',
        'AGYS':'Agilysys ‚Äî hospitality tech PMS POS inventory software for hotels casinos resorts; revenue ~$240M growing 18% YoY; high recurring revenue',
        'SMCI':'Super Micro Computer ‚Äî AI server GPU rack infrastructure; revenue ~$15B FY2024; Nvidia partner; accounting investigation risk 2024',
        'RMBS':'Rambus ‚Äî semiconductor interface IP licensing DDR5; revenue ~$145M; high-margin royalty model',
        'ACLS':'Axcelis Technologies ‚Äî ion implant equipment for semiconductor fabs; revenue ~$1.1B; SiC power chip exposure',
        'SPSC':'SPS Commerce ‚Äî supply chain EDI SaaS; revenue ~$600M growing 20%+; B2B network effects',
        'ALRM':'Alarm.com ‚Äî smart home commercial security SaaS platform; revenue ~$1B; 10000+ dealer network',
        'KTOS':'Kratos Defense ‚Äî unmanned aerial systems drone targets; revenue ~$1B; DoD pipeline strong',
        'AEIS':'Advanced Energy Industries ‚Äî precision power for semiconductor equipment; revenue ~$1.8B',
        'FORM':'FormFactor ‚Äî semiconductor wafer probe cards; revenue ~$750M; TSMC Samsung critical supplier',
        'NSIT':'Insight Direct ‚Äî corporate IT products cloud services; revenue ~$9B value-add reseller',
        'CARG':'CarGurus ‚Äî online used car marketplace dealer tools; revenue ~$900M',
        'PRGS':'Progress Software ‚Äî OpenEdge Telerik dev tools; revenue ~$600M acqui-growth',
        'DFIN':'Donnelley Financial ‚Äî SEC filing compliance SaaS ActiveDisclosure; revenue ~$1B',
        'ITRI':'Itron ‚Äî smart meters grid analytics utilities; revenue ~$2.4B; grid modernization beneficiary',
        'MGNI':'Magnite ‚Äî programmatic CTV advertising sell-side; revenue ~$600M; streaming tailwinds',
        'IRTC':'iRhythm Technologies ‚Äî Zio cardiac monitoring patch 14-day; revenue ~$600M; disruptive vs Holter',
        'CABO':'Cable One/Sparklight ‚Äî rural broadband ISP; revenue ~$1.6B; fiber competition risk',
        'CNXN':'Connection (PC Connection) ‚Äî corporate IT products; revenue ~$2.9B',
        'RELY':'Remitly Global ‚Äî digital international money transfers; revenue ~$1.1B growing 30%+ YoY',
        'BAND':'Bandwidth ‚Äî cloud communications CPaaS APIs for enterprises; revenue ~$700M',
        'APPN':'Appian ‚Äî low-code process automation platform; revenue ~$420M; government enterprise focus',
        'JAMF':'Jamf ‚Äî Apple device management MDM for enterprises; revenue ~$700M; sticky IT contracts',
        'PCTY':'Paylocity ‚Äî cloud HR payroll for mid-market; revenue ~$1.2B growing 18% YoY',
        'PAYC':'Paycom Software ‚Äî HR payroll automation GONE; revenue ~$1.7B; Beti product differentiation',
        'NCNO':'nCino ‚Äî cloud banking software for financial institutions; revenue ~$530M',
        'SMAR':'Smartsheet ‚Äî work management collaboration platform; revenue ~$1.1B; Microsoft Teams competition',
        'NTNX':'Nutanix ‚Äî hyper-converged infrastructure cloud software; revenue ~$2.2B; subscription transition complete',
        'PUBM':'PubMatic ‚Äî programmatic digital advertising sell-side; revenue ~$280M',
        'QTWO':'Q2 Holdings ‚Äî digital banking software for community banks; revenue ~$700M',
        'TNET':'TriNet Group ‚Äî PEO HR services for SMBs; revenue ~$5.4B',
        'CSGS':'CSG Systems ‚Äî revenue management billing SaaS for telecoms; revenue ~$1.1B',
        'POWI':'Power Integrations ‚Äî power conversion ICs EV charging; revenue ~$500M',
        // ‚îÄ‚îÄ Russell 2000 Healthcare ‚îÄ‚îÄ
        'HALO':'Halozyme ‚Äî ENHANZE drug delivery platform licensed to AbbVie Roche Janssen; royalties ~$800M growing; asset-light',
        'TGTX':'TG Therapeutics ‚Äî Briumvi ublituximab for MS launched 2023; revenue growing ~$300M',
        'PTCT':'PTC Therapeutics ‚Äî Duchenne muscular dystrophy rare disease; revenue ~$900M',
        'CPRX':'Catalyst Pharmaceuticals ‚Äî Firdapse Lambert-Eaton rare disease; revenue ~$340M orphan exclusivity',
        'AGIO':'Agios Pharmaceuticals ‚Äî mitapivat sickle cell thalassemia; revenue ~$250M growing',
        'AORT':'Artivion (CryoLife) ‚Äî aortic stent grafts On-X heart valves surgical sealants; revenue ~$441M',
        'PAHC':'Phibro Animal Health ‚Äî veterinary pharmaceuticals nutrition; revenue ~$1B',
        'NEOG':'Neogen Corp ‚Äî food animal safety testing; revenue ~$900M',
        'HIMS':'Hims & Hers Health ‚Äî telehealth weight loss hair ED skincare; revenue ~$1.5B growing 60%+',
        'QDEL':'QuidelOrtho ‚Äî rapid diagnostics COVID flu RSV; revenue ~$2.8B',
        'TMDX':'TransMedics Group ‚Äî Organ Care System warm perfusion transplants; revenue ~$300M growing 80%+',
        'GKOS':'Glaukos ‚Äî iStent glaucoma eye implant; revenue ~$380M',
        'ACAD':'ACADIA Pharmaceuticals ‚Äî Nuplazid Parkinson psychosis; revenue ~$600M',
        'SRPT':'Sarepta Therapeutics ‚Äî Elevidys DMD gene therapy; revenue ~$1.5B',
        'FOLD':'Amicus Therapeutics ‚Äî Pompe Fabry rare enzyme therapy; revenue ~$400M',
        'IONS':'Ionis Pharmaceuticals ‚Äî antisense oligonucleotide platform 40+ drugs; revenue ~$900M',
        'IOVA':'Iovance Biotherapeutics ‚Äî TIL cell therapy lifileucel melanoma first approved 2024',
        'RXRX':'Recursion Pharmaceuticals ‚Äî AI drug discovery platform; Roche Bayer partnerships',
        'CRSP':'CRISPR Therapeutics ‚Äî Casgevy sickle cell gene editing first approved CRISPR medicine',
        'SAGE':'Sage Therapeutics ‚Äî zuranolone depression Biogen partnership; revenue ramping',
        'NVAX':'Novavax ‚Äî protein subunit COVID flu vaccine; Sanofi partnership 2024',
        'SWAV':'ShockWave Medical ‚Äî coronary lithotripsy; acquired by J&J 2024',
        'USPH':'U.S. Physical Therapy ‚Äî outpatient PT clinics nationwide; revenue ~$600M',
        'MGPI':'MGP Ingredients ‚Äî premium aged whiskey food-grade starches; revenue ~$800M',
        'MSGS':'Madison Square Garden Sports ‚Äî Knicks NBA Rangers NHL trophy asset',
        'HTLF':'Heartland Financial ‚Äî Midwest regional bank $22B assets',
        'SFBS':'ServisFirst Bancshares ‚Äî Alabama commercial bank $20B assets high ROA',
        // ‚îÄ‚îÄ Russell 2000 Financials ‚îÄ‚îÄ
        'MYRG':'MYR Group ‚Äî electrical construction data centers grid; revenue ~$3.5B',
        'LQDT':'Liquidity Services ‚Äî B2B reverse logistics auctions; revenue ~$330M',
        'HTLD':'Heartland Express ‚Äî truckload carrier; revenue ~$700M',
        'INVA':'Innoviva ‚Äî GSK respiratory royalties Advair Breo Anoro; revenue ~$280M high-margin',
        'DXPE':'DXP Enterprises ‚Äî industrial MRO distribution; revenue ~$1.7B',
        'CADE':'Cadence Bank ‚Äî Southeast commercial bank $50B assets',
        'COLB':'Columbia Banking ‚Äî Pacific Northwest $52B assets post-Umpqua',
        'FFIN':'First Financial Bankshares ‚Äî Texas community bank $14B assets',
        'GABC':'German American Bancorp ‚Äî Indiana community bank $7B assets',
        'HTGC':'Hercules Capital ‚Äî BDC venture tech lending; ~10% dividend yield',
        'CODI':'Compass Diversified ‚Äî permanent capital niche industrial brands',
        'WSFS':'WSFS Financial ‚Äî Delaware bank wealth management $20B assets',
        'ABCB':'Ameris Bancorp ‚Äî Southeast US bank $26B assets',
        'BANF':'BancFirst Corp ‚Äî Oklahoma community bank $12B assets',
        'BANR':'Banner Bank ‚Äî Pacific Northwest bank $15B assets',
        'BHLB':'Berkshire Hills Bancorp ‚Äî New England commercial bank $12B assets',
        'CFFN':'Capitol Federal Financial ‚Äî Kansas mortgage savings bank',
        'EFSC':'Enterprise Financial Services ‚Äî Missouri community bank',
        'EGBN':'Eagle Bancorp ‚Äî Washington DC commercial bank $10B assets',
        'FBNC':'First Bancorp ‚Äî North Carolina community bank $8B assets',
        'FFBC':'First Financial Bancorp ‚Äî Ohio Indiana commercial bank $16B assets',
        'FISI':'Financial Institutions ‚Äî New York community bank',
        'FULT':'Fulton Financial ‚Äî Pennsylvania mid-Atlantic bank $32B assets',
        'GABC':'German American Bancorp ‚Äî Indiana community bank',
        'HFWA':'Heritage Financial ‚Äî Pacific Northwest community bank',
        'TRMK':'Trustmark Corp ‚Äî Mississippi Alabama regional bank',
        // ‚îÄ‚îÄ Russell 2000 Industrials ‚îÄ‚îÄ
        'SAIA':'Saia Inc ‚Äî LTL freight carrier national expansion; revenue ~$3.2B',
        'GTLS':'Chart Industries ‚Äî industrial gas equipment LNG heat exchangers; revenue ~$4B',
        'CSWI':'CSW Industrials ‚Äî HVAC plumbing contractor products; revenue ~$900M',
        'UFPI':'UFP Industries ‚Äî engineered wood construction retail industrial; revenue ~$7B',
        'ESAB':'ESAB Corp ‚Äî welding cutting equipment global; revenue ~$2.6B',
        'AAON':'AAON Inc ‚Äî commercial HVAC data center cooling; revenue ~$900M premium margins',
        'HLIO':'Helios Technologies ‚Äî hydraulic electronic control systems; revenue ~$2B',
        'BOOT':'Boot Barn ‚Äî Western workwear retail 400+ stores; revenue ~$1.7B',
        'MYRG':'MYR Group ‚Äî electrical contractor data centers grid; revenue ~$3.5B',
        'AVAV':'AeroVironment ‚Äî tactical drones military; revenue ~$700M; Ukraine demand',
        'BWXT':'BWX Technologies ‚Äî Navy nuclear reactor components; revenue ~$2.6B national security moat',
        'ARCB':'ArcBest ‚Äî LTL freight logistics; revenue ~$4.5B',
        'APOG':'Apogee Enterprises ‚Äî architectural glass commercial buildings; revenue ~$1.4B',
        'BRKR':'Bruker ‚Äî scientific instruments NMR mass spec; revenue ~$2.8B',
        'CPRT':'Copart ‚Äî vehicle salvage auction online; revenue ~$4B high moat',
        'LDOS':'Leidos ‚Äî IT services US government defense; revenue ~$15B',
        'PLXS':'Plexus Corp ‚Äî complex electronics manufacturing; revenue ~$4B',
        'ESAB':'ESAB Corp ‚Äî welding cutting equipment; revenue ~$2.6B',
        // ‚îÄ‚îÄ Russell 2000 Energy ‚îÄ‚îÄ
        'CHRD':'Chord Energy ‚Äî Permian Williston Basin E&P; revenue ~$2B; strong FCF',
        'ARCH':'Arch Resources ‚Äî metallurgical coal steelmaking; revenue ~$2.5B; merging CEIX',
        'REPX':'Riley Exploration Permian ‚Äî small cap E&P; revenue ~$350M disciplined',
        'DNOW':'NOW Inc ‚Äî energy industrial distribution; revenue ~$2.4B',
        'CEIX':'CONSOL Energy ‚Äî met thermal coal Appalachia; revenue ~$2.4B; merging Arch',
        'DINO':'HF Sinclair ‚Äî refining marketing midstream; revenue ~$25B',
        'GPOR':'Gulfport Energy ‚Äî Utica shale natural gas; revenue ~$1.3B',
        'BORR':'Borr Drilling ‚Äî offshore jack-up rigs; dayrates recovering',
        'CLNE':'Clean Energy Fuels ‚Äî natural gas vehicle fueling stations; revenue ~$450M',
        // ‚îÄ‚îÄ Russell 2000 Consumer ‚îÄ‚îÄ
        'PZZA':'Papa Johns ‚Äî pizza franchise 5500+ locations; revenue ~$2.1B',
        'BURL':'Burlington Stores ‚Äî off-price apparel retail; revenue ~$10B',
        'CAKE':'Cheesecake Factory ‚Äî casual dining North Italia; revenue ~$3.5B',
        'CBRL':'Cracker Barrel ‚Äî highway restaurant retail; revenue ~$3.4B turnaround',
        'BLMN':'Bloomin Brands ‚Äî Outback Steakhouse; revenue ~$4.9B',
        'JBLU':'JetBlue Airways ‚Äî low-cost carrier; revenue ~$9B high debt',
        'JOBY':'Joby Aviation ‚Äî electric air taxi eVTOL pre-revenue; Toyota backed FAA certification',
        'GRWG':'GrowGeneration ‚Äî hydroponic garden retail cannabis; revenue ~$230M',
        'BOOT':'Boot Barn ‚Äî Western lifestyle workwear; revenue ~$1.7B',
        'PTLO':'Portillo\'s ‚Äî Chicago-style fast casual restaurants; revenue ~$700M',
        'TRUP':'Trupanion ‚Äî pet insurance subscription; revenue ~$1.3B; growing pet humanization trend',
        'CHEF':'The Chefs Warehouse ‚Äî specialty food distribution for restaurants; revenue ~$3.9B',
        // ‚îÄ‚îÄ Additional Russell 2000 misc ‚îÄ‚îÄ
        'AORT':'Artivion ‚Äî aortic surgery medical devices; revenue ~$441M',
        'AAON':'AAON Inc ‚Äî commercial HVAC; revenue ~$900M',
        'HTLF':'Heartland Financial ‚Äî Midwest bank $22B assets',
        'IDEX':'IDEX Corp ‚Äî fluidics pumps industrial medical; revenue ~$3.3B',
        'MSGS':'MSG Sports ‚Äî Knicks Rangers trophy asset',
        'LNTH':'Lantheus Holdings ‚Äî radiopharmaceutical diagnostics PYLARIFY PET imaging; revenue ~$1.4B',
        'SWAV':'ShockWave Medical ‚Äî coronary lithotripsy J&J acquisition 2024',
        'INMD':'InMode ‚Äî minimally invasive aesthetic medical devices; revenue ~$500M high margin',
        'GKOS':'Glaukos ‚Äî iStent glaucoma; revenue ~$380M',
        'ICAD':'iCAD ‚Äî AI-powered cancer detection radiology; small cap ~$50M revenue',
        'IRDM':'Iridium Communications ‚Äî satellite IoT connectivity global coverage; revenue ~$800M',
        'JOBY':'Joby Aviation ‚Äî eVTOL air taxi Toyota partner; pre-revenue FAA path',
        'RGEN':'Repligen ‚Äî bioprocessing equipment for biopharma manufacturing; revenue ~$750M',
        'UCTT':'Ultra Clean Holdings ‚Äî semiconductor equipment components cleaning; revenue ~$2B',
        'COHU':'Cohu ‚Äî semiconductor test handler equipment; revenue ~$500M',
        'SANM':'Sanmina ‚Äî electronics manufacturing services; revenue ~$8.5B',
        'KLIC':'Kulicke & Soffa ‚Äî semiconductor wire bonding equipment; revenue ~$700M',
        'FORM':'FormFactor ‚Äî wafer probe cards; revenue ~$750M TSMC Samsung key',
        'ACMR':'ACM Research ‚Äî semiconductor cleaning equipment China exposure; revenue ~$700M',
        'CRUS':'Cirrus Logic ‚Äî audio chips for Apple iPhone; revenue ~$1.9B Apple dependent',
        'SITM':'SiTime ‚Äî MEMS timing semiconductors; revenue ~$200M growing',
        'CRDO':'Credo Technology ‚Äî high-speed connectivity chips for AI data centers; revenue ~$438M',
        'KSCP':'Knightscope ‚Äî autonomous security robots; small pre-revenue',
        'VZIO':'Vizio ‚Äî smart TVs advertising platform; acquired by Walmart 2024',
      };

      // Build enrichment context ‚Äî include company name + market cap for stocks
      const enrichContextLines = parsed.map(a => {
        if(a.type === 'stock') {
          const name = STOCK_NAMES[a.symbol] || (a.symbol + ' (NYSE/NASDAQ listed company)');
          const mcap = a.marketCap ? ' market cap $'+(a.marketCap>=1e9?(a.marketCap/1e9).toFixed(1)+'B':(a.marketCap/1e6).toFixed(0)+'M') : '';
          return a.symbol + ' = ' + name + (mcap ? ',' + mcap : '');
        }
        return a.symbol; // crypto symbols are self-explanatory
      });
      const enrichList = enrichContextLines.join('\n');

      const enrichPrompt = `You are a financial research analyst. Analyze each asset below.

CRITICAL INSTRUCTIONS:
- A full company description is provided for most assets ‚Äî USE IT
- For any asset where you are uncertain, USE YOUR WEB SEARCH TOOL to look up the company/token before responding
- NEVER respond with "insufficient data" or "unable to determine" ‚Äî always research and provide real analysis
- For crypto tokens, provide analysis on the project's technology, adoption, and ecosystem

Assets to analyze (ticker = company/project description):
${enrichList}

Return a JSON array with one object per asset:
{
  "symbol": "TICKER",
  "fundamentals": "One sentence: financial health, revenue growth, profitability, or for crypto: adoption TVL tokenomics.",
  "disruptive": "One sentence: is the technology or business model genuinely differentiated vs competitors?",
  "news": "1-2 sentences: most recent notable developments, launches, partnerships, risks as of early 2025.",
  "verdict": "STRONG" or "NEUTRAL" or "WEAK"
}

verdict criteria:
- STRONG = solid/growing financials + real competitive moat + positive recent momentum
- WEAK   = deteriorating fundamentals, major scandal, dead project, or structural decline
- NEUTRAL = mixed signals, stable but uninspiring, or limited differentiation

Return ONLY the raw JSON array. No markdown, no backticks, no preamble.`;

      try {
        const enrichResponse = await callAIWithSearch(enrichPrompt);
        let enrichData = [];
        try {
          let clean = enrichResponse.replace(/```json|```/gi,'').trim();
          const s = clean.indexOf('['), e = clean.lastIndexOf(']');
          if(s!==-1 && e>s) enrichData = JSON.parse(clean.slice(s,e+1));
        } catch(e2){
          const objs = enrichResponse.match(/\{[\s\S]*?\}/g)||[];
          objs.forEach(o=>{ try{ enrichData.push(JSON.parse(o)); }catch(e3){} });
        }
        // Attach enrichment ‚Äî only non-numeric knowledge fields
        enrichData.forEach(enrich => {
          const alert = allAlerts.find(a=>a.symbol===enrich.symbol);
          if(alert){
            alert.fundamentals = enrich.fundamentals || '';
            alert.disruptive   = enrich.disruptive   || '';
            alert.news         = enrich.news         || '';
            alert.verdict      = enrich.verdict      || 'NEUTRAL';
          }
        });
        allAlerts.sort((a,b)=>b.score-a.score);
        renderAlerts(allAlerts);
      } catch(e){ console.warn('Enrichment failed:',e.message); }

      document.getElementById('loading').classList.remove('visible');

    } catch(err) {
      showError('ERROR: ' + err.message);
      console.error(err);
    }
  }
</script>
</body>
</html>